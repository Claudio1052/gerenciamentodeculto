<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Cultos - Verbo da Vida Zona Leste</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ... (todo o CSS anterior permanece igual) ... */
        :root {
            --primary: #1a5fb4;
            --primary-dark: #0d4a8a;
            --secondary: #e67e22;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ... (restante do CSS permanece igual) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-message" style="margin-top: 20px; color: var(--primary); font-weight: 500;"></div>
        </div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <h1>Verbo da Vida</h1>
                <p>Zona Leste - Gestão de Cultos</p>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="active" id="dashboard-tab"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#registro" id="registro-tab"><i class="fas fa-plus-circle"></i> Novo Culto</a></li>
                <li><a href="#historico" id="historico-tab"><i class="fas fa-history"></i> Histórico</a></li>
                <li><a href="#escalas" id="escalas-tab"><i class="fas fa-users"></i> Escalas</a></li>
                <li><a href="#membros" id="membros-tab"><i class="fas fa-address-book"></i> Membros</a></li>
                <li><a href="#relatorios" id="relatorios-tab"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
                <li><a href="#configuracoes" id="configuracoes-tab"><i class="fas fa-cog"></i> Configurações</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <header>
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-title">
                        <h2 id="page-title">Dashboard de Cultos</h2>
                        <p id="page-subtitle">Sistema de gerenciamento de cultos da Igreja Verbo da Vida Zona Leste</p>
                        <p id="connection-status" style="font-size: 0.8rem; margin-top: 5px;"></p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                    <div>
                        <div class="user-name">Administrador</div>
                        <div class="user-role">Coordenador de Cultos</div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="tab-content active">
                <div class="cards-container" id="dashboard-cards">
                    <!-- Cards serão carregados via JavaScript -->
                </div>

                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-container">
                        <h3 class="chart-title">Frequência por Tipo de Culto</h3>
                        <canvas id="cultoTypeChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Gênero e Idade</h3>
                        <canvas id="demographicsChart"></canvas>
                    </div>
                </div>

                <!-- Últimos Cultos -->
                <div class="section">
                    <h3 class="section-title">Últimos Cultos Registrados</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Dia</th>
                                    <th>Tipo</th>
                                    <th>Público</th>
                                    <th>Ministro</th>
                                    <th>Dirigente</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ultimos-cultos">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Novo Culto Section -->
            <section id="registro" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Registrar Novo Culto</h3>
                    <form id="culto-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="data-culto">Data do Culto</label>
                                <input type="date" id="data-culto" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="dia-semana">Dia da Semana</label>
                                <select id="dia-semana" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    <option value="terca">Terça-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="domingo">Domingo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tipo-culto">Tipo de Culto</label>
                                <select id="tipo-culto" class="form-control" required>
                                    <option value="">Selecione...</option>
                                    <option value="familia">Culto da Família</option>
                                    <option value="jovens">Culto de Jovens</option>
                                    <option value="oracao">Culto de Oração</option>
                                    <option value="ceia">Santa Ceia</option>
                                    <option value="especial">Culto Especial</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="hora-inicio">Hora de Início</label>
                                <input type="time" id="hora-inicio" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="hora-termino">Hora de Término</label>
                                <input type="time" id="hora-termino" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="tempo-ministerio">Tempo de Ministração (minutos)</label>
                                <input type="number" id="tempo-ministerio" class="form-control" min="1" max="120" required>
                            </div>
                        </div>

                        <h4 class="section-title" style="margin-top: 30px;">Público Presente</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="homens">Homens</label>
                                <input type="number" id="homens" class="form-control" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="mulheres">Mulheres</label>
                                <input type="number" id="mulheres" class="form-control" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="criancas">Crianças (até 12 anos)</label>
                                <input type="number" id="criancas" class="form-control" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="total-presentes">Total Presentes</label>
                                <input type="number" id="total-presentes" class="form-control" readonly>
                            </div>
                        </div>

                        <h4 class="section-title" style="margin-top: 30px;">Liderança do Culto</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ministro">Ministro</label>
                                <input type="text" id="ministro" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="dirigente">Dirigente</label>
                                <input type="text" id="dirigente" class="form-control" required>
                            </div>
                        </div>

                        <h4 class="section-title" style="margin-top: 30px;">Equipes Escaladas</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="diaconato">Diaconato</label>
                                <input type="text" id="diaconato" class="form-control" placeholder="Nomes separados por vírgula" required>
                            </div>
                            <div class="form-group">
                                <label for="infantil">Departamento Infantil</label>
                                <input type="text" id="infantil" class="form-control" placeholder="Nomes separados por vírgula" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="conselheiros">Conselheiros</label>
                                <input type="text" id="conselheiros" class="form-control" placeholder="Nomes separados por vírgula" required>
                            </div>
                            <div class="form-group">
                                <label for="musica">Departamento de Música</label>
                                <input type="text" id="musica" class="form-control" placeholder="Nomes separados por vírgula" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="midia">Mídia</label>
                                <input type="text" id="midia" class="form-control" placeholder="Nomes separados por vírgula" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="observacoes">Observações</label>
                                <textarea id="observacoes" class="form-control" rows="3"></textarea>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Registrar Culto
                            </button>
                            <button type="button" class="btn btn-secondary" id="limpar-form">
                                <i class="fas fa-eraser"></i> Limpar Formulário
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Histórico Section -->
            <section id="historico" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Histórico de Cultos</h3>
                    
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="todos">Todos os Cultos</button>
                        <button class="tab-btn" data-tab="terca">Terças-feiras</button>
                        <button class="tab-btn" data-tab="quinta">Quintas-feiras</button>
                        <button class="tab-btn" data-tab="domingo">Domingos</button>
                    </div>
                    
                    <div class="tab-content active" id="todos">
                        <div class="table-responsive">
                            <table class="table" id="tabela-historico">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Dia</th>
                                        <th>Tipo</th>
                                        <th>Público</th>
                                        <th>Início</th>
                                        <th>Término</th>
                                        <th>Ministro</th>
                                        <th>Dirigente</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="historico-cultos">
                                    <!-- Dados serão carregados via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Escalas Section -->
            <section id="escalas" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Escalas de Serviço</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data-escala">Selecionar Data</label>
                            <input type="date" id="data-escala" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="tipo-escala">Filtrar por Departamento</label>
                            <select id="tipo-escala" class="form-control">
                                <option value="todos">Todos os Departamentos</option>
                                <option value="diaconato">Diaconato</option>
                                <option value="infantil">Departamento Infantil</option>
                                <option value="conselheiros">Conselheiros</option>
                                <option value="musica">Departamento de Música</option>
                                <option value="midia">Mídia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="escalados-list" id="lista-escalas">
                        <!-- Dados serão carregados via JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Membros Section -->
            <section id="membros" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Gerenciar Membros</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" id="btn-novo-membro">
                            <i class="fas fa-plus"></i> Novo Membro
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Departamentos</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-membros">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Relatórios Section -->
            <section id="relatorios" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Relatórios Analíticos</h3>
                    
                    <div class="stats-grid" id="relatorios-stats">
                        <!-- Estatísticas serão carregadas via JavaScript -->
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-container">
                            <h3 class="chart-title">Frequência por Dia da Semana</h3>
                            <canvas id="weekdayChart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <h3 class="chart-title">Crescimento de Público</h3>
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Top Ministros</h3>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Ministro</th>
                                        <th>Cultos Ministrados</th>
                                        <th>Público Médio</th>
                                        <th>Total de Pessoas</th>
                                    </tr>
                                </thead>
                                <tbody id="top-ministros">
                                    <!-- Dados serão carregados via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Configurações Section -->
            <section id="configuracoes" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Configurações do Sistema</h3>
                    
                    <form id="config-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nome-igreja">Nome da Igreja</label>
                                <input type="text" id="nome-igreja" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="horarios-cultos">Horários de Cultos Padrão</label>
                                <input type="text" id="horarios-cultos" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="backup">Backup Automático</label>
                                <select id="backup" class="form-control" required>
                                    <option value="diario">Diário</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="mensal">Mensal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notificacoes">Notificações</label>
                                <select id="notificacoes" class="form-control" required>
                                    <option value="ativas">Ativas</option>
                                    <option value="inativas">Inativas</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Salvar Configurações
                            </button>
                            <button type="button" class="btn btn-primary" id="btn-exportar">
                                <i class="fas fa-file-export"></i> Exportar Dados
                            </button>
                            <button type="button" class="btn btn-warning" id="btn-testar-conexao">
                                <i class="fas fa-wifi"></i> Testar Conexão
                            </button>
                        </div>
                    </form>
                    
                    <div class="section" style="margin-top: 30px;">
                        <h4 class="section-title">Status da Conexão</h4>
                        <div id="status-conexao">
                            <p><strong>URL do Supabase:</strong> <span id="supabase-url">https://wzzyxbkhmldfilvlihvl.supabase.co</span></p>
                            <p><strong>Status:</strong> <span id="status-text" class="badge badge-warning">Verificando...</span></p>
                            <p><strong>Tabelas configuradas:</strong> <span id="tabelas-status">Verificando...</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="footer">
                <p>Sistema de Gerenciamento de Cultos - Igreja Verbo da Vida Zona Leste &copy; 2023</p>
                <p>Desenvolvido para glorificar a Deus e facilitar a administração dos cultos</p>
            </footer>
        </main>
    </div>

    <!-- Modal para detalhes do culto -->
    <div class="modal" id="modal-detalhes">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes do Culto</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div id="modal-detalhes-content">
                <!-- Conteúdo será carregado via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar membro -->
    <div class="modal" id="modal-membro">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-membro-title">Novo Membro</h3>
                <button class="modal-close" id="modal-membro-close">&times;</button>
            </div>
            <form id="form-membro">
                <input type="hidden" id="membro-id">
                <div class="form-group">
                    <label for="membro-nome">Nome Completo</label>
                    <input type="text" id="membro-nome" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="membro-email">Email</label>
                        <input type="email" id="membro-email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="membro-telefone">Telefone</label>
                        <input type="text" id="membro-telefone" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="membro-departamentos">Departamentos (separe por vírgula)</label>
                    <input type="text" id="membro-departamentos" class="form-control" placeholder="Ex: Diaconato, Música, Infantil">
                </div>
                <div class="form-group">
                    <label for="membro-ativo">
                        <input type="checkbox" id="membro-ativo" checked> Membro Ativo
                    </label>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-secondary" id="btn-cancelar-membro">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // Configuração do Supabase - CORRIGIDA para usar método mais compatível
        const SUPABASE_URL = 'https://wzzyxbkhmldfilvlihvl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6enl4YmtobWxmaWx2bGlodnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTAzNzcsImV4cCI6MjA3ODYyNjM3N30.K_QwwVD20xnlhNvTxb0jdTeH_3LU30W_aDeHquraQg8';

        // Estado da aplicação
        let estado = {
            cultos: [],
            escalas: [],
            membros: [],
            configuracoes: {},
            charts: {},
            conectado: false
        };

        // Elementos DOM
        let elementos = {};

        // Função para testar conexão com Supabase
        async function testarConexaoSupabase() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    return { success: true, message: 'Conexão estabelecida com sucesso!' };
                } else {
                    return { success: false, message: `Erro ${response.status}: ${response.statusText}` };
                }
            } catch (error) {
                return { success: false, message: `Falha na conexão: ${error.message}` };
            }
        }

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Coletar elementos DOM importantes
            coletarElementos();
            
            // Configurar eventos
            configurarEventos();
            
            // Testar conexão inicial
            await verificarConexao();
            
            // Se não estiver conectado, usar dados locais
            if (!estado.conectado) {
                usarDadosLocais();
            } else {
                await carregarDadosIniciais();
            }
            
            // Configurar data atual nos formulários
            const hoje = new Date().toISOString().split('T')[0];
            elementos.dataCulto.value = hoje;
            elementos.dataEscala.value = hoje;
            
            // Esconder loading
            elementos.loadingOverlay.style.display = 'none';
        });

        // Coletar elementos DOM
        function coletarElementos() {
            elementos = {
                // Elementos gerais
                menuToggle: document.getElementById('menu-toggle'),
                sidebar: document.getElementById('sidebar'),
                mainContent: document.getElementById('main-content'),
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingMessage: document.getElementById('loading-message'),
                connectionStatus: document.getElementById('connection-status'),
                statusConexao: document.getElementById('status-conexao'),
                statusText: document.getElementById('status-text'),
                tabelasStatus: document.getElementById('tabelas-status'),
                supabaseUrl: document.getElementById('supabase-url'),
                
                // Navegação
                tabButtons: document.querySelectorAll('.nav-menu a'),
                tabContents: document.querySelectorAll('.tab-content'),
                pageTitle: document.getElementById('page-title'),
                pageSubtitle: document.getElementById('page-subtitle'),
                
                // Dashboard
                dashboardCards: document.getElementById('dashboard-cards'),
                ultimosCultos: document.getElementById('ultimos-cultos'),
                
                // Formulário de culto
                cultoForm: document.getElementById('culto-form'),
                limparFormBtn: document.getElementById('limpar-form'),
                dataCulto: document.getElementById('data-culto'),
                diaSemana: document.getElementById('dia-semana'),
                tipoCulto: document.getElementById('tipo-culto'),
                horaInicio: document.getElementById('hora-inicio'),
                horaTermino: document.getElementById('hora-termino'),
                tempoMinisterio: document.getElementById('tempo-ministerio'),
                homens: document.getElementById('homens'),
                mulheres: document.getElementById('mulheres'),
                criancas: document.getElementById('criancas'),
                totalPresentes: document.getElementById('total-presentes'),
                ministro: document.getElementById('ministro'),
                dirigente: document.getElementById('dirigente'),
                diaconato: document.getElementById('diaconato'),
                infantil: document.getElementById('infantil'),
                conselheiros: document.getElementById('conselheiros'),
                musica: document.getElementById('musica'),
                midia: document.getElementById('midia'),
                observacoes: document.getElementById('observacoes'),
                
                // Histórico
                historicoCultos: document.getElementById('historico-cultos'),
                tabHistoricoButtons: document.querySelectorAll('.tab-btn'),
                
                // Escalas
                dataEscala: document.getElementById('data-escala'),
                tipoEscala: document.getElementById('tipo-escala'),
                listaEscalas: document.getElementById('lista-escalas'),
                
                // Membros
                btnNovoMembro: document.getElementById('btn-novo-membro'),
                listaMembros: document.getElementById('lista-membros'),
                modalMembro: document.getElementById('modal-membro'),
                modalMembroTitle: document.getElementById('modal-membro-title'),
                formMembro: document.getElementById('form-membro'),
                membroId: document.getElementById('membro-id'),
                membroNome: document.getElementById('membro-nome'),
                membroEmail: document.getElementById('membro-email'),
                membroTelefone: document.getElementById('membro-telefone'),
                membroDepartamentos: document.getElementById('membro-departamentos'),
                membroAtivo: document.getElementById('membro-ativo'),
                btnCancelarMembro: document.getElementById('btn-cancelar-membro'),
                modalMembroClose: document.getElementById('modal-membro-close'),
                
                // Configurações
                configForm: document.getElementById('config-form'),
                nomeIgreja: document.getElementById('nome-igreja'),
                horariosCultos: document.getElementById('horarios-cultos'),
                backup: document.getElementById('backup'),
                notificacoes: document.getElementById('notificacoes'),
                btnExportar: document.getElementById('btn-exportar'),
                btnTestarConexao: document.getElementById('btn-testar-conexao'),
                
                // Modal detalhes
                modalDetalhes: document.getElementById('modal-detalhes'),
                modalDetalhesContent: document.getElementById('modal-detalhes-content'),
                modalClose: document.getElementById('modal-close'),
                
                // Toast
                toastContainer: document.getElementById('toast-container')
            };
        }

        // Configurar eventos
        function configurarEventos() {
            // Menu toggle
            elementos.menuToggle.addEventListener('click', function() {
                elementos.sidebar.classList.toggle('active');
                elementos.mainContent.classList.toggle('active');
            });
            
            // Navegação entre abas
            elementos.tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    
                    // Atualizar título da página
                    atualizarTituloPagina(targetId);
                    
                    // Ativar aba clicada
                    elementos.tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar conteúdo correspondente
                    elementos.tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Fechar menu em mobile
                    if (window.innerWidth < 992) {
                        elementos.sidebar.classList.remove('active');
                        elementos.mainContent.classList.remove('active');
                    }
                    
                    // Carregar dados específicos da aba
                    switch(targetId) {
                        case 'dashboard':
                            carregarDashboard();
                            break;
                        case 'historico':
                            carregarHistorico();
                            break;
                        case 'escalas':
                            carregarEscalas();
                            break;
                        case 'membros':
                            carregarMembros();
                            break;
                        case 'relatorios':
                            carregarRelatorios();
                            break;
                        case 'configuracoes':
                            carregarConfiguracoes();
                            break;
                    }
                });
            });
            
            // Calcular total de presentes automaticamente
            elementos.homens.addEventListener('input', calcularTotal);
            elementos.mulheres.addEventListener('input', calcularTotal);
            elementos.criancas.addEventListener('input', calcularTotal);
            
            // Limpar formulário de culto
            elementos.limparFormBtn.addEventListener('click', function() {
                elementos.cultoForm.reset();
                elementos.totalPresentes.value = '';
            });
            
            // Envio do formulário de culto
            elementos.cultoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await registrarCulto();
            });
            
            // Navegação entre abas do histórico
            elementos.tabHistoricoButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Ativar botão clicado
                    elementos.tabHistoricoButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filtrar histórico
                    filtrarHistorico(tabId);
                });
            });
            
            // Filtros de escalas
            elementos.dataEscala.addEventListener('change', carregarEscalas);
            elementos.tipoEscala.addEventListener('change', carregarEscalas);
            
            // Gerenciamento de membros
            elementos.btnNovoMembro.addEventListener('click', () => abrirModalMembro());
            elementos.btnCancelarMembro.addEventListener('click', () => fecharModalMembro());
            elementos.modalMembroClose.addEventListener('click', () => fecharModalMembro());
            elementos.formMembro.addEventListener('submit', async (e) => {
                e.preventDefault();
                await salvarMembro();
            });
            
            // Configurações
            elementos.configForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await salvarConfiguracoes();
            });
            
            elementos.btnExportar.addEventListener('click', exportarDados);
            elementos.btnTestarConexao.addEventListener('click', testarConexao);
            
            // Modal detalhes
            elementos.modalClose.addEventListener('click', () => {
                elementos.modalDetalhes.classList.remove('active');
            });
            
            // Fechar modal ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === elementos.modalDetalhes) {
                    elementos.modalDetalhes.classList.remove('active');
                }
                if (e.target === elementos.modalMembro) {
                    fecharModalMembro();
                }
            });
        }

        // Funções auxiliares
        function calcularTotal() {
            const homensVal = parseInt(elementos.homens.value) || 0;
            const mulheresVal = parseInt(elementos.mulheres.value) || 0;
            const criancasVal = parseInt(elementos.criancas.value) || 0;
            const total = homensVal + mulheresVal + criancasVal;
            elementos.totalPresentes.value = total;
        }

        function atualizarTituloPagina(aba) {
            const titulos = {
                dashboard: ['Dashboard de Cultos', 'Sistema de gerenciamento de cultos da Igreja Verbo da Vida Zona Leste'],
                registro: ['Registrar Novo Culto', 'Preencha os dados do culto para registro no sistema'],
                historico: ['Histórico de Cultos', 'Consulte todos os cultos realizados por dia da semana'],
                escalas: ['Escalas de Serviço', 'Visualize as escalas dos voluntários por departamento'],
                membros: ['Gerenciar Membros', 'Cadastre e gerencie os membros da igreja'],
                relatorios: ['Relatórios Analíticos', 'Análises detalhadas sobre frequência e crescimento'],
                configuracoes: ['Configurações do Sistema', 'Personalize as configurações do sistema de gestão']
            };
            
            if (titulos[aba]) {
                elementos.pageTitle.textContent = titulos[aba][0];
                elementos.pageSubtitle.textContent = titulos[aba][1];
            }
        }

        function formatarData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR');
        }

        function formatarDia(dia) {
            const dias = {
                'domingo': 'Domingo',
                'terca': 'Terça-feira',
                'quinta': 'Quinta-feira'
            };
            return dias[dia] || dia;
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            toast.textContent = mensagem;
            
            elementos.toastContainer.appendChild(toast);
            
            // Remover toast após 5 segundos
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Funções de conexão
        async function verificarConexao() {
            try {
                elementos.loadingMessage.textContent = 'Verificando conexão com o banco de dados...';
                
                const resultado = await testarConexaoSupabase();
                
                if (resultado.success) {
                    estado.conectado = true;
                    elementos.connectionStatus.innerHTML = '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Conectado ao Supabase</span>';
                    elementos.statusText.textContent = 'Conectado';
                    elementos.statusText.className = 'badge badge-success';
                    
                    // Verificar tabelas
                    await verificarTabelas();
                    
                    mostrarToast('Conectado ao banco de dados com sucesso!', 'success');
                } else {
                    estado.conectado = false;
                    elementos.connectionStatus.innerHTML = `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Modo offline - Dados locais</span>`;
                    elementos.statusText.textContent = 'Offline';
                    elementos.statusText.className = 'badge badge-warning';
                    elementos.tabelasStatus.textContent = 'Usando dados locais';
                    
                    mostrarToast('Modo offline: usando dados locais. ' + resultado.message, 'warning');
                }
            } catch (error) {
                estado.conectado = false;
                elementos.connectionStatus.innerHTML = `<span style="color: var(--danger);"><i class="fas fa-times-circle"></i> Erro de conexão</span>`;
                elementos.statusText.textContent = 'Erro';
                elementos.statusText.className = 'badge badge-danger';
                elementos.tabelasStatus.textContent = 'Erro ao verificar tabelas';
                
                mostrarToast('Erro ao conectar com o banco de dados. Usando dados locais.', 'error');
            }
        }

        async function verificarTabelas() {
            try {
                // Testar cada tabela
                const tabelas = ['cultos', 'escalas', 'membros', 'configuracoes'];
                const resultados = [];
                
                for (const tabela of tabelas) {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${tabela}?limit=1`, {
                            method: 'GET',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        resultados.push({
                            tabela,
                            existe: response.ok
                        });
                    } catch (error) {
                        resultados.push({
                            tabela,
                            existe: false
                        });
                    }
                }
                
                const tabelasExistentes = resultados.filter(r => r.existe).map(r => r.tabela);
                elementos.tabelasStatus.textContent = tabelasExistentes.join(', ') || 'Nenhuma tabela encontrada';
                
                if (tabelasExistentes.length < 4) {
                    mostrarToast(`Atenção: ${4 - tabelasExistentes.length} tabela(s) não encontrada(s). Execute o SQL fornecido.`, 'warning');
                }
                
            } catch (error) {
                elementos.tabelasStatus.textContent = 'Erro ao verificar tabelas';
            }
        }

        async function testarConexao() {
            elementos.loadingOverlay.style.display = 'flex';
            elementos.loadingMessage.textContent = 'Testando conexão...';
            
            await verificarConexao();
            
            if (estado.conectado) {
                // Recarregar dados do banco
                await carregarDadosIniciais();
                mostrarToast('Conexão restabelecida! Dados carregados do banco.', 'success');
            }
            
            elementos.loadingOverlay.style.display = 'none';
        }

        // Função para usar dados locais quando offline
        function usarDadosLocais() {
            // Carregar dados do localStorage se existirem
            const dadosLocais = localStorage.getItem('cultos_verbo_vida');
            
            if (dadosLocais) {
                const dados = JSON.parse(dadosLocais);
                estado.cultos = dados.cultos || [];
                estado.escalas = dados.escalas || [];
                estado.membros = dados.membros || [];
                estado.configuracoes = dados.configuracoes || {};
                
                mostrarToast('Dados locais carregados do cache.', 'info');
            } else {
                // Dados de exemplo iniciais
                estado.cultos = [
                    {
                        id: 1,
                        data_culto: new Date().toISOString().split('T')[0],
                        dia_semana: 'domingo',
                        tipo_culto: 'Culto da Família',
                        hora_inicio: '18:00',
                        hora_termino: '19:45',
                        tempo_ministerio: 45,
                        homens: 120,
                        mulheres: 150,
                        criancas: 35,
                        ministro: 'Pr. João Silva',
                        dirigente: 'Irmão Marcos Oliveira',
                        observacoes: 'Culto abençoado com várias decisões por Cristo'
                    }
                ];
                
                estado.escalas = [
                    { id: 1, culto_id: 1, departamento: 'Diaconato', nomes: 'Carlos, Roberto, Miguel' },
                    { id: 2, culto_id: 1, departamento: 'Departamento Infantil', nomes: 'Ana, Patricia, Juliana' },
                    { id: 3, culto_id: 1, departamento: 'Conselheiros', nomes: 'Fernando, Ricardo, Gustavo' },
                    { id: 4, culto_id: 1, departamento: 'Departamento de Música', nomes: 'Banda Avivah' },
                    { id: 5, culto_id: 1, departamento: 'Mídia', nomes: 'Rafael, Lucas' }
                ];
                
                estado.membros = [
                    { id: 1, nome: 'Carlos Silva', email: 'carlos@email.com', telefone: '(11) 99999-9999', departamentos: ['Diaconato'], ativo: true },
                    { id: 2, nome: 'Ana Santos', email: 'ana@email.com', telefone: '(11) 98888-8888', departamentos: ['Departamento Infantil'], ativo: true },
                    { id: 3, nome: 'Fernando Oliveira', email: 'fernando@email.com', telefone: '(11) 97777-7777', departamentos: ['Conselheiros'], ativo: true }
                ];
                
                estado.configuracoes = {
                    nome_igreja: 'Igreja Verbo da Vida Zona Leste',
                    horarios_cultos: 'Terça e Quinta: 19:30, Domingo: 18:00',
                    backup_automatico: 'semanal',
                    notificacoes: 'ativas'
                };
                
                mostrarToast('Sistema iniciado em modo offline com dados de exemplo.', 'info');
            }
            
            // Salvar dados locais para uso futuro
            salvarDadosLocais();
            
            // Carregar interface
            carregarDashboard();
            inicializarCharts();
        }

        function salvarDadosLocais() {
            const dados = {
                cultos: estado.cultos,
                escalas: estado.escalas,
                membros: estado.membros,
                configuracoes: estado.configuracoes,
                dataSalvamento: new Date().toISOString()
            };
            
            localStorage.setItem('cultos_verbo_vida', JSON.stringify(dados));
        }

        // Carregar dados iniciais
        async function carregarDadosIniciais() {
            try {
                elementos.loadingMessage.textContent = 'Carregando dados do banco...';
                
                if (!estado.conectado) {
                    usarDadosLocais();
                    return;
                }
                
                // Tentar carregar dados do Supabase
                // Nota: Estamos usando fetch diretamente para melhor compatibilidade com CORS
                
                // Carregar cultos
                const responseCultos = await fetch(`${SUPABASE_URL}/rest/v1/cultos?select=*&order=data_culto.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (responseCultos.ok) {
                    estado.cultos = await responseCultos.json();
                } else {
                    throw new Error(`Erro ao carregar cultos: ${responseCultos.status}`);
                }
                
                // Carregar escalas
                const responseEscalas = await fetch(`${SUPABASE_URL}/rest/v1/escalas?select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (responseEscalas.ok) {
                    estado.escalas = await responseEscalas.json();
                }
                
                // Carregar membros
                const responseMembros = await fetch(`${SUPABASE_URL}/rest/v1/membros?select=*&order=nome.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (responseMembros.ok) {
                    estado.membros = await responseMembros.json();
                }
                
                // Carregar configurações
                const responseConfigs = await fetch(`${SUPABASE_URL}/rest/v1/configuracoes?select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (responseConfigs.ok) {
                    const configs = await responseConfigs.json();
                    estado.configuracoes = {};
                    configs.forEach(config => {
                        estado.configuracoes[config.chave] = config.valor;
                    });
                }
                
                // Salvar backup local
                salvarDadosLocais();
                
                // Carregar dashboard
                carregarDashboard();
                
                // Inicializar gráficos
                inicializarCharts();
                
                mostrarToast('Dados carregados do banco com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                estado.conectado = false;
                elementos.connectionStatus.innerHTML = `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Modo offline - Dados locais</span>`;
                
                // Usar dados locais como fallback
                usarDadosLocais();
            }
        }

        // Funções de carregamento de dados
        async function carregarDashboard() {
            try {
                // Calcular estatísticas
                const totalCultos = estado.cultos.length;
                const totalPessoas = estado.cultos.reduce((total, culto) => {
                    return total + culto.homens + culto.mulheres + culto.criancas;
                }, 0);
                const mediaPublico = totalCultos > 0 ? Math.round(totalPessoas / totalCultos) : 0;
                
                // Determinar próximo culto
                const hoje = new Date();
                const diasSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const diaSemanaAtual = diasSemana[hoje.getDay()];
                
                let proximoCulto = "Domingo";
                let proximoCultoTipo = "Culto da Família";
                
                if (diaSemanaAtual === 'terca' || diaSemanaAtual === 'quarta') {
                    proximoCulto = "Quinta";
                    proximoCultoTipo = "Culto de Oração";
                } else if (diaSemanaAtual === 'quinta' || diaSemanaAtual === 'sexta' || diaSemanaAtual === 'sabado') {
                    proximoCulto = "Domingo";
                    proximoCultoTipo = "Culto da Família";
                } else {
                    proximoCulto = "Terça";
                    proximoCultoTipo = "Culto de Jovens";
                }
                
                // Atualizar cards do dashboard
                elementos.dashboardCards.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Cultos Realizados</div>
                            <div class="card-icon icon-blue">
                                <i class="fas fa-church"></i>
                            </div>
                        </div>
                        <div class="card-value">${totalCultos}</div>
                        <div class="card-change ${totalCultos > 0 ? 'positive' : ''}">
                            <i class="fas fa-${totalCultos > 0 ? 'arrow-up' : 'minus'}"></i> 
                            ${totalCultos > 0 ? 'Registrados' : 'Nenhum culto'}
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Média de Público</div>
                            <div class="card-icon icon-green">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value">${mediaPublico}</div>
                        <div class="card-change ${mediaPublico > 0 ? 'positive' : ''}">
                            <i class="fas fa-${mediaPublico > 0 ? 'arrow-up' : 'minus'}"></i> 
                            ${mediaPublico > 0 ? 'pessoas por culto' : 'Sem dados'}
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Próximo Culto</div>
                            <div class="card-icon icon-orange">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="card-value">${proximoCulto}</div>
                        <div class="card-change">${proximoCulto === 'Domingo' ? '18:00' : '19:30'} - ${proximoCultoTipo}</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total de Pessoas</div>
                            <div class="card-icon icon-green">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="card-value">${totalPessoas.toLocaleString()}</div>
                        <div class="card-change ${totalPessoas > 0 ? 'positive' : ''}">
                            <i class="fas fa-${totalPessoas > 0 ? 'arrow-up' : 'minus'}"></i> 
                            ${totalPessoas > 0 ? 'pessoas alcançadas' : 'Sem registros'}
                        </div>
                    </div>
                `;
                
                // Carregar últimos cultos
                elementos.ultimosCultos.innerHTML = '';
                
                const ultimosCultos = estado.cultos.slice(0, 5);
                
                if (ultimosCultos.length === 0) {
                    elementos.ultimosCultos.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <i class="fas fa-church" style="font-size: 2rem; color: var(--gray); margin-bottom: 10px; display: block;"></i>
                                <p>Nenhum culto registrado ainda.</p>
                                <a href="#registro" style="color: var(--primary);">Clique aqui para registrar o primeiro culto</a>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                ultimosCultos.forEach(culto => {
                    const totalPresentes = culto.homens + culto.mulheres + culto.criancas;
                    const diaFormatado = formatarDia(culto.dia_semana);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatarData(culto.data_culto)}</td>
                        <td>${diaFormatado}</td>
                        <td>${culto.tipo_culto}</td>
                        <td><strong>${totalPresentes}</strong> pessoas</td>
                        <td>${culto.ministro}</td>
                        <td>${culto.dirigente}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 0.9rem;" onclick="verDetalhesCulto(${culto.id})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                    `;
                    elementos.ultimosCultos.appendChild(row);
                });
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                mostrarToast('Erro ao carregar dashboard', 'error');
            }
        }

        // ... (as outras funções permanecem similares, mas adaptadas para usar fetch diretamente)

        async function registrarCulto() {
            try {
                elementos.loadingOverlay.style.display = 'flex';
                elementos.loadingMessage.textContent = 'Salvando culto...';
                
                // Preparar dados do culto
                const cultoData = {
                    data_culto: elementos.dataCulto.value,
                    dia_semana: elementos.diaSemana.value,
                    tipo_culto: elementos.tipoCulto.value,
                    hora_inicio: elementos.horaInicio.value,
                    hora_termino: elementos.horaTermino.value,
                    tempo_ministerio: parseInt(elementos.tempoMinisterio.value),
                    homens: parseInt(elementos.homens.value) || 0,
                    mulheres: parseInt(elementos.mulheres.value) || 0,
                    criancas: parseInt(elementos.criancas.value) || 0,
                    ministro: elementos.ministro.value,
                    dirigente: elementos.dirigente.value,
                    observacoes: elementos.observacoes.value
                };
                
                let novoCultoId;
                
                if (estado.conectado) {
                    // Tentar salvar no Supabase
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/cultos`, {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(cultoData)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erro ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        novoCultoId = data[0].id;
                        cultoData.id = novoCultoId;
                        
                        // Salvar escalas
                        const escalasData = [
                            { culto_id: novoCultoId, departamento: 'Diaconato', nomes: elementos.diaconato.value },
                            { culto_id: novoCultoId, departamento: 'Departamento Infantil', nomes: elementos.infantil.value },
                            { culto_id: novoCultoId, departamento: 'Conselheiros', nomes: elementos.conselheiros.value },
                            { culto_id: novoCultoId, departamento: 'Departamento de Música', nomes: elementos.musica.value },
                            { culto_id: novoCultoId, departamento: 'Mídia', nomes: elementos.midia.value }
                        ];
                        
                        for (const escala of escalasData) {
                            await fetch(`${SUPABASE_URL}/rest/v1/escalas`, {
                                method: 'POST',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(escala)
                            });
                        }
                        
                        mostrarToast('Culto registrado no banco de dados!', 'success');
                        
                    } catch (supabaseError) {
                        console.error('Erro ao salvar no Supabase:', supabaseError);
                        estado.conectado = false;
                        elementos.connectionStatus.innerHTML = `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Modo offline</span>`;
                        mostrarToast('Salvando localmente. ' + supabaseError.message, 'warning');
                        
                        // Continuar com salvamento local
                        throw new Error('Falha na conexão com o banco');
                    }
                }
                
                // Se não está conectado ou falhou, usar ID local
                if (!novoCultoId) {
                    novoCultoId = Date.now();
                    cultoData.id = novoCultoId;
                }
                
                // Adicionar ao estado local
                estado.cultos.unshift(cultoData);
                
                // Adicionar escalas ao estado local
                const escalasData = [
                    { id: Date.now() + 1, culto_id: novoCultoId, departamento: 'Diaconato', nomes: elementos.diaconato.value },
                    { id: Date.now() + 2, culto_id: novoCultoId, departamento: 'Departamento Infantil', nomes: elementos.infantil.value },
                    { id: Date.now() + 3, culto_id: novoCultoId, departamento: 'Conselheiros', nomes: elementos.conselheiros.value },
                    { id: Date.now() + 4, culto_id: novoCultoId, departamento: 'Departamento de Música', nomes: elementos.musica.value },
                    { id: Date.now() + 5, culto_id: novoCultoId, departamento: 'Mídia', nomes: elementos.midia.value }
                ];
                
                escalasData.forEach(escala => estado.escalas.push(escala));
                
                // Salvar dados locais
                salvarDadosLocais();
                
                // Limpar formulário
                elementos.cultoForm.reset();
                elementos.totalPresentes.value = '';
                
                // Atualizar dashboard
                carregarDashboard();
                
                // Mostrar mensagem de sucesso
                mostrarToast('Culto registrado com sucesso!', 'success');
                
                // Ir para o dashboard
                document.querySelector('[href="#dashboard"]').click();
                
            } catch (error) {
                console.error('Erro ao registrar culto:', error);
                mostrarToast('Erro ao registrar culto: ' + error.message, 'error');
            } finally {
                elementos.loadingOverlay.style.display = 'none';
            }
        }

        // ... (outras funções adaptadas para usar fetch)

        async function exportarDados() {
            try {
                elementos.loadingOverlay.style.display = 'flex';
                elementos.loadingMessage.textContent = 'Preparando exportação...';
                
                // Preparar dados para exportação
                const dadosExportacao = {
                    cultos: estado.cultos,
                    escalas: estado.escalas,
                    membros: estado.membros,
                    configuracoes: estado.configuracoes,
                    dataExportacao: new Date().toISOString(),
                    origem: estado.conectado ? 'Supabase + Local' : 'Local',
                    versaoSistema: '1.0.0'
                };
                
                // Converter para JSON
                const jsonString = JSON.stringify(dadosExportacao, null, 2);
                
                // Criar blob e download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-cultos-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarToast('Dados exportados com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                mostrarToast('Erro ao exportar dados', 'error');
            } finally {
                elementos.loadingOverlay.style.display = 'none';
            }
        }

        // Funções de gráficos
        function inicializarCharts() {
            // ... (código dos gráficos permanece similar)
        }

        // Tornar funções disponíveis globalmente
        window.verDetalhesCulto = async function(id) {
            try {
                const culto = estado.cultos.find(c => c.id === id);
                if (!culto) return;
                
                // Buscar escalas deste culto
                let escalas = estado.escalas.filter(e => e.culto_id === id);
                
                const totalPresentes = culto.homens + culto.mulheres + culto.criancas;
                const diaFormatado = formatarDia(culto.dia_semana);
                const dataFormatada = formatarData(culto.data_culto);
                
                // Preparar conteúdo do modal
                let escalasHTML = '';
                if (escalas && escalas.length > 0) {
                    escalas.forEach(escala => {
                        escalasHTML += `<p><strong>${escala.departamento}:</strong> ${escala.nomes}</p>`;
                    });
                } else {
                    escalasHTML = '<p>Nenhuma escala registrada para este culto.</p>';
                }
                
                elementos.modalDetalhesContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <p><strong>Data:</strong> ${dataFormatada} (${diaFormatado})</p>
                        <p><strong>Tipo de Culto:</strong> ${culto.tipo_culto}</p>
                        <p><strong>Horário:</strong> ${culto.hora_inicio} às ${culto.hora_termino}</p>
                        <p><strong>Tempo de Ministração:</strong> ${culto.tempo_ministerio} minutos</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Público Presente</h4>
                        <p><strong>Homens:</strong> ${culto.homens}</p>
                        <p><strong>Mulheres:</strong> ${culto.mulheres}</p>
                        <p><strong>Crianças:</strong> ${culto.criancas}</p>
                        <p><strong>Total:</strong> ${totalPresentes} pessoas</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Liderança</h4>
                        <p><strong>Ministro:</strong> ${culto.ministro}</p>
                        <p><strong>Dirigente:</strong> ${culto.dirigente}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Equipes Escaladas</h4>
                        ${escalasHTML}
                    </div>
                    
                    ${culto.observacoes ? `
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Observações</h4>
                        <p>${culto.observacoes}</p>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                        <p style="font-size: 0.9rem; color: var(--gray);">
                            <i class="fas fa-info-circle"></i> 
                            ${estado.conectado ? 'Dados sincronizados com o banco' : 'Dados armazenados localmente'}
                        </p>
                    </div>
                `;
                
                // Mostrar modal
                elementos.modalDetalhes.classList.add('active');
                
            } catch (error) {
                console.error('Erro ao carregar detalhes do culto:', error);
                mostrarToast('Erro ao carregar detalhes do culto', 'error');
            }
        };

        window.excluirCulto = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este culto? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                elementos.loadingOverlay.style.display = 'flex';
                elementos.loadingMessage.textContent = 'Excluindo culto...';
                
                if (estado.conectado) {
                    // Tentar excluir do Supabase
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/cultos?id=eq.${id}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erro ao excluir do banco: ${response.status}`);
                        }
                    } catch (supabaseError) {
                        console.error('Erro ao excluir do Supabase:', supabaseError);
                        estado.conectado = false;
                        elementos.connectionStatus.innerHTML = `<span style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Modo offline</span>`;
                    }
                }
                
                // Atualizar estado local
                estado.cultos = estado.cultos.filter(c => c.id !== id);
                estado.escalas = estado.escalas.filter(e => e.culto_id !== id);
                
                // Salvar dados locais
                salvarDadosLocais();
                
                // Atualizar interface
                carregarDashboard();
                
                // Recarregar outras abas se estiverem visíveis
                if (document.getElementById('historico').classList.contains('active')) {
                    carregarHistorico();
                }
                if (document.getElementById('escalas').classList.contains('active')) {
                    carregarEscalas();
                }
                
                mostrarToast('Culto excluído com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir culto:', error);
                mostrarToast('Erro ao excluir culto', 'error');
            } finally {
                elementos.loadingOverlay.style.display = 'none';
            }
        };

        // ... (outras funções globais)
    </script>
</body>
</html>
