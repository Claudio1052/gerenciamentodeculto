<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Ministerial | Verbo da Vida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Variáveis de Tema Padrão (Light Mode) */
        :root {
            --primary: #1a5fb4;
            --primary-dark: #0d4a8a;
            --primary-light: #4a8ad4;
            --secondary: #e67e22;
            --secondary-dark: #c45a10;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --dark-light: #34495e;
            --success: #27ae60;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --gray: #6c757d;
            --bg-main: #f4f6f9;
            --bg-card: #ffffff;
            --bg-sidebar: #2c3e50;
            --text-main: #212529;
            --text-light: #f8f9fa;
            --border-color: #dee2e6;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --radius: 8px;
        }
        /* Dark Mode */
        [data-theme="dark"] {
            --primary: #4a8ad4;
            --primary-dark: #1a5fb4;
            --secondary: #f39c12;
            --dark: #f8f9fa;
            --bg-main: #1f2a37; /* slate-800 */
            --bg-card: #303e4d; /* slate-700 */
            --bg-sidebar: #111827; /* gray-900 */
            --text-main: #f9fafb;
            --text-light: #1f2a37;
            --border-color: #3e4d5f;
            --shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: all 0.3s;
        }
        /* Layout */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            color: var(--text-light);
            position: fixed;
            height: 100%;
            padding: 20px;
            box-shadow: var(--shadow);
            z-index: 100;
            transition: transform 0.3s;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            transition: margin-left 0.3s;
        }
        /* Sidebar - Brand & Navigation */
        .brand {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--primary-light);
            display: flex; align-items: center; gap: 10px;
        }
        .nav-menu { list-style: none; }
        .nav-menu a {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: var(--radius);
            margin-bottom: 5px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .nav-menu a:hover, .nav-menu a.active {
            background-color: var(--primary);
            color: var(--text-light);
            box-shadow: 0 4px 8px rgba(26, 95, 180, 0.3);
        }
        .nav-menu i { width: 20px; text-align: center; }
        .badge { background: var(--secondary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: auto; }
        /* Top Bar */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .page-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .user-profile {
            display: flex; align-items: center; gap: 10px;
            cursor: pointer;
            background: var(--bg-card);
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: var(--shadow);
        }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem;
        }
        .user-info span { font-size: 0.9rem; font-weight: 500; display: block; line-height: 1.2; }
        .user-info small { font-size: 0.75rem; color: var(--gray); }
        /* Content & Tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section {
            background-color: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-dark);
        }
    
        /* Cards Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform 0.2s;
            border: 1px solid var(--border-color);
        }
        .card:hover { transform: translateY(-3px); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-title { font-size: 0.9rem; color: var(--gray); font-weight: 500; }
        .card-icon { width: 40px; height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .card-value { font-size: 2.2rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .card-subvalue { font-size: 0.8rem; color: var(--gray); margin-top: 5px; }
        .card-success .card-icon { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .card-info .card-icon { background: rgba(26, 95, 180, 0.1); color: var(--primary); }
        .card-warning .card-icon { background: rgba(230, 126, 34, 0.1); color: var(--secondary); }
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .input-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 95, 180, 0.2);
            background-color: var(--bg-card);
        }
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--bg-main); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #a71d2a; }
        /* Settings */
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-info h4 { font-size: 1rem; margin-bottom: 5px; }
        .setting-info p { font-size: 0.85rem; color: var(--gray); }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        /* Conexão Status */
        .connection-status {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.8rem; padding: 5px 10px; border-radius: 4px;
            position: fixed; top: 10px; right: 10px; z-index: 1000;
            box-shadow: var(--shadow);
            color: white;
        }
        .status-ok { background-color: var(--success); }
        .status-error { background-color: var(--danger); }
        /* Loading */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            transition: opacity 0.3s;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2100; }
        .toast {
            padding: 10px 20px; margin-top: 10px; border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-main);
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px;
            border-left: 5px solid;
            animation: slideIn 0.3s forwards;
        }
        .toast-success { border-color: var(--success); }
        .toast-error { border-color: var(--danger); }
        .toast-info { border-color: var(--info); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* Mobile */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.active { margin-left: 250px; }
            .menu-toggle { display: block; }
            .chart-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="connection-status status-error" id="connection-status">
        <i class="fas fa-sync fa-spin"></i> Testando Conexão...
    </div>
    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text">Carregando dados...</p>
    </div>
    <div class="wrapper">
        <nav class="sidebar" id="sidebar">
            <div class="brand"><i class="fas fa-church"></i> VerboApp</div>
        
            <ul class="nav-menu">
                <li><a href="#dashboard" class="active" id="dashboard-tab"><i class="fas fa-chart-line"></i> Dashboard <span class="badge" id="dashboard-badge">0</span></a></li>
                <li><a href="#registro" id="registro-tab"><i class="fas fa-plus-circle"></i> Novo Culto</a></li>
                <li><a href="#historico" id="historico-tab"><i class="fas fa-history"></i> Histórico <span class="badge" id="historico-badge">0</span></a></li>
                <li><a href="#escalas" id="escalas-tab"><i class="fas fa-clipboard-list"></i> Escalas</a></li>
                <li><a href="#membros" id="membros-tab"><i class="fas fa-address-book"></i> Membros</a></li>
                <li><a href="#configuracoes" id="configuracoes-tab"><i class="fas fa-cog"></i> Configurações</a></li>
            </ul>
        
            <div style="margin-top: 50px;">
                <button class="btn btn-secondary" style="width:100%;" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </nav>
        <main class="main-content" id="main-content">
            <div class="top-bar">
                <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
                <div class="page-title" id="current-title">Dashboard</div>
                <div class="user-profile">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <span>Admin</span>
                        <small>Coordenador</small>
                    </div>
                </div>
            </div>
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid" id="dashboard-cards">
                    </div>
            
                <div class="chart-grid">
                    <div class="section">
                        <h3 class="section-title">Tendência de Público</h3>
                        <div class="chart-container"><canvas id="growthChart"></canvas></div>
                    </div>
                    <div class="section">
                        <h3 class="section-title">Distribuição por Gênero</h3>
                        <div class="chart-container" style="height: 250px;"><canvas id="demographicsChart"></canvas></div>
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">Atividade Recente</h3>
                    <div class="table-responsive">
                        <table class="table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="border-bottom:2px solid #eee; text-align:left;">
                                    <th style="padding:15px;">Data</th>
                                    <th style="padding:15px;">Tipo</th>
                                    <th style="padding:15px;">Público</th>
                                    <th style="padding:15px;">Ministro</th>
                                </tr>
                            </thead>
                            <tbody id="timeline-events">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="registro" class="tab-content">
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-plus-circle"></i> Registrar Novo Culto</h3>
                    <form id="culto-form">
                    
                        <h4 style="margin-top:20px; margin-bottom:10px; color:var(--primary);">Informações Básicas</h4>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="data-culto">Data do Culto</label>
                                <input type="date" id="data-culto" class="input-control" required>
                            </div>
                            <div class="input-group">
                                <label for="dia-semana">Dia da Semana</label>
                                <select id="dia-semana" class="input-control" required>
                                    <option value="Domingo">Domingo</option>
                                    <option value="Segunda">Segunda-feira</option>
                                    <option value="Terça">Terça-feira</option>
                                    <option value="Quarta">Quarta-feira</option>
                                    <option value="Quinta">Quinta-feira</option>
                                    <option value="Sexta">Sexta-feira</option>
                                    <option value="Sábado">Sábado</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="tipo-culto">Tipo de Culto</label>
                                <select id="tipo-culto" class="input-control" required>
                                    <option value="Culto da Família">Culto da Família</option>
                                    <option value="Culto de Oração">Culto de Oração</option>
                                    <option value="Culto de Jovens">Culto de Jovens</option>
                                    <option value="Santa Ceia">Santa Ceia</option>
                                    <option value="Especial">Especial</option>
                                </select>
                            </div>
                        </div>
                    
                        <div class="form-grid">
                            <div class="input-group"><label for="hora-inicio">Início</label><input type="time" id="hora-inicio" class="input-control" value="19:30" required></div>
                            <div class="input-group"><label for="hora-termino">Término</label><input type="time" id="hora-termino" class="input-control" value="21:30" required></div>
                            <div class="input-group"><label for="tempo-ministerio">Duração Palavra (min)</label><input type="number" id="tempo-ministerio" class="input-control" value="60"></div>
                        </div>
                    
                        <h4 style="margin-top:30px; margin-bottom:10px; color:var(--primary);">Contagem de Pessoas</h4>
                        <div class="form-grid">
                            <div class="input-group"><label for="homens">Homens</label><input type="number" id="homens" class="input-control" value="0"></div>
                            <div class="input-group"><label for="mulheres">Mulheres</label><input type="number" id="mulheres" class="input-control" value="0"></div>
                            <div class="input-group"><label for="criancas">Crianças</label><input type="number" id="criancas" class="input-control" value="0"></div>
                            <div class="input-group"><label for="total-presentes">Total Geral</label><input type="number" id="total-presentes" class="input-control" readonly style="font-weight:bold; background-color: var(--bg-main);"></div>
                        </div>
                        <h4 style="margin-top:30px; margin-bottom:10px; color:var(--primary);">Equipes e Liderança</h4>
                        <div class="form-grid">
                            <div class="input-group"><label for="ministro">Ministro da Palavra</label><input type="text" id="ministro" class="input-control" required></div>
                            <div class="input-group"><label for="dirigente">Dirigente do Culto</label><input type="text" id="dirigente" class="input-control"></div>
                        </div>
                    
                        <div class="form-grid">
                            <div class="input-group"><label for="diaconato">Diaconato (Equipe)</label><select id="diaconato" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="infantil">Infantil (Equipe)</label><select id="infantil" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="musica">Música (Equipe)</label><select id="musica" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="midia">Mídia (Equipe)</label><select id="midia" class="input-control" multiple></select></div>
                        </div>
                        <div class="form-grid">
                            <div class="input-group"><label for="recepcao">Recepção (Equipe)</label><select id="recepcao" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="jovens">Jovens (Equipe)</label><select id="jovens" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="transito">Transito (Equipe)</label><select id="transito" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="concelheiros">Concelheiros (Equipe)</label><select id="concelheiros" class="input-control" multiple></select></div>
                        </div>
                        <div class="form-grid">
                            <div class="input-group"><label for="livraria">Livraria (Equipe)</label><select id="livraria" class="input-control" multiple></select></div>
                            <div class="input-group"><label for="ministros">Ministros (Equipe)</label><select id="ministros" class="input-control" multiple></select></div>
                        </div>
                    
                        <div class="input-group">
                            <label for="observacoes">Observações</label>
                            <textarea id="observacoes" class="input-control" rows="3" placeholder="Informações adicionais, ocorrências..."></textarea>
                        </div>
                    
                        <div style="margin-top:30px; display:flex; gap:15px;">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Registro</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('culto-form').reset()"><i class="fas fa-redo"></i> Limpar</button>
                        </div>
                    </form>
                </div>
            </div>
        
            <div id="historico" class="tab-content">
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-history"></i> Histórico Completo</h3>
                    <div id="historico-table-container">
                        </div>
                </div>
            </div>
            <div id="escalas" class="tab-content">
                <div class="section">
                    <h3 class="section-title"><i class="fas fa-clipboard-list"></i> Escalas</h3>
                    <!-- Filtros -->
                    <div style="margin-bottom: 25px; background: var(--bg-main); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow);">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">Filtros</h4>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="filtro-data-escala">Data</label>
                                <input type="date" id="filtro-data-escala" class="input-control">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openModalEscala()" style="margin-bottom:20px;">
                        Nova Escala
                    </button>
                    <div class="dashboard-grid" id="lista-escalas">
                        </div>
                </div>
            </div>
            <div id="membros" class="tab-content">
    <div class="section">
        <h3 class="section-title">Gestão de Membros</h3>
     
        <!-- Filtros -->
        <div style="margin-bottom: 25px; background: var(--bg-main); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow);">
            <h4 style="margin-bottom: 15px; color: var(--primary);">Filtros</h4>
            <div class="form-grid">
                <div class="input-group">
                    <label>Pesquisar por nome</label>
                    <input type="text" id="filtro-nome" class="input-control" placeholder="Digite o nome...">
                </div>
                <div class="input-group">
                    <label>Departamento</label>
                    <select id="filtro-departamento" class="input-control">
                        <option value="">Todos</option>
                        <option>Diaconato</option>
                        <option>Música</option>
                        <option>Infantil</option>
                        <option>Mídia</option>
                        <option>Recepção</option>
                        <option>Jovens</option>
                        <option>Transito</option>
                         <option>Concelheiros</option>
                         <option>Livraria</option>
                        <option>Ministros</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Aniversário este mês</label>
                    <select id="filtro-aniversario" class="input-control">
                        <option value="">Não</option>
                        <option value="sim">Sim (destaque)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Fez Rhema?</label>
                    <select id="filtro-rhema" class="input-control">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Fez Escola de Ministros?</label>
                    <select id="filtro-escola-ministros" class="input-control">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
            </div>
        </div>
        <button class="btn btn-primary" onclick="openModalMembro()" style="margin-bottom:20px;">
            Novo Membro
        </button>
        <div id="membros-table-container"></div>
    </div>
</div>
            <div id="configuracoes" class="tab-content">
                <div class="section" style="max-width: 600px; margin: 0 auto;">
                    <h3 class="section-title"><i class="fas fa-cog"></i> Configurações do Sistema</h3>
                
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Modo Escuro (Dark Mode)</h4>
                            <p>Alterna o esquema de cores para o modo noturno.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleDarkMode(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Exportar Dados (Backup)</h4>
                            <p>Baixe todos os dados registrados em formato CSV.</p>
                        </div>
                        <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                
                    <div class="setting-item" style="border-bottom: none;">
                        <div class="setting-info">
                            <h4 style="color: var(--danger);">Resetar Dados</h4>
                            <p>Apaga permanentemente todos os registros do banco de dados.</p>
                        </div>
                        <button class="btn btn-danger" onclick="alert('Funcionalidade de Reset bloqueada na demonstração.')"><i class="fas fa-trash-alt"></i> Resetar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="modal" id="modal-membro" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000;">
    <div class="modal-content" style="background:var(--bg-card); padding:30px; border-radius:var(--radius); width:90%; max-width:500px; box-shadow:var(--shadow);">
        <h3 class="section-title" style="margin-bottom:20px;">Novo / Editar Membro</h3>
        <form id="form-membro">
            <input type="hidden" id="membro-id">
            <div class="form-grid">
                <div class="input-group">
                    <label for="membro-nome">Nome Completo *</label>
                    <input type="text" id="membro-nome" class="input-control" required>
                </div>
                <div class="input-group">
                    <label for="membro-telefone">Telefone (WhatsApp)</label>
                    <input type="tel" id="membro-telefone" class="input-control" placeholder="(99) 99999-9999">
                </div>
            </div>
            <div class="form-grid">
                <div class="input-group">
                    <label for="membro-nascimento">Data de Nascimento</label>
                    <input type="date" id="membro-nascimento" class="input-control">
                </div>
                <div class="input-group">
                    <label for="membro-email">E-mail</label>
                    <input type="email" id="membro-email" class="input-control">
                </div>
            </div>
            <div class="form-grid">
                <div class="input-group">
                    <label>Fez Rhema?</label>
                    <select id="membro-rhema" class="input-control">
                        <option value="false">Não</option>
                        <option value="true">Sim</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Escola de Ministros?</label>
                    <select id="membro-escola" class="input-control">
                        <option value="false">Não</option>
                        <option value="true">Sim</option>
                    </select>
                </div>
            </div>
            <div class="input-group" style="margin:20px 0;">
                <label for="membro-departamentos">Departamentos</label>
                <select id="membro-departamentos" class="input-control" multiple>
                    <option value="Diaconato">Diaconato</option>
                    <option value="Música">Música</option>
                    <option value="Infantil">Infantil</option>
                    <option value="Mídia">Mídia</option>
                    <option value="Recepção">Recepção</option>
                    <option value="Jovens">Jovens</option>
                    <option value="Transito">Transito</option>
                     <option value="Concelheiros">Concelheiros</option>
                     <option value="Livraria">Livraria</option>
                     <option value="Ministros">Ministros</option>
  
                </select>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalMembro()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Membro</button>
            </div>
        </form>
    </div>
</div>
<div class="modal" id="modal-escala" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000;">
    <div class="modal-content" style="background:var(--bg-card); padding:30px; border-radius:var(--radius); width:90%; max-width:1000px; max-height:80vh; overflow-y:auto; box-shadow:var(--shadow);">
        <h3 class="section-title" style="margin-bottom:20px;">Nova / Editar Escala</h3>
        <form id="form-escala">
            <input type="hidden" id="edit-date">
            <div class="input-group">
                <label for="data-escala">Data da Escala *</label>
                <input type="date" id="data-escala" class="input-control" required>
            </div>
            <h4 style="margin-top:30px; margin-bottom:10px; color:var(--primary);">Equipes</h4>
            <div class="form-grid">
                <div class="input-group"><label for="diaconato-escala">Diaconato</label><select id="diaconato-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="musica-escala">Música</label><select id="musica-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="midia-escala">Mídia</label><select id="midia-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="recepcao-escala">Recepção</label><select id="recepcao-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="jovens-escala">Jovens</label><select id="jovens-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="transito-escala">Transito</label><select id="transito-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="concelheiros-escala">Concelheiros</label><select id="concelheiros-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="livraria-escala">Livraria</label><select id="livraria-escala" class="input-control" multiple></select></div>
                <div class="input-group"><label for="ministros-escala">Ministros</label><select id="ministros-escala" class="input-control" multiple></select></div>
            </div>
            <h4 style="margin-top:30px; margin-bottom:10px; color:var(--primary);">Infantil por Salas</h4>
            <div class="form-grid">
                <div class="input-group"><label for="infantil-0-2">0 a 2 anos</label><select id="infantil-0-2" class="input-control" multiple></select></div>
                <div class="input-group"><label for="infantil-3-5">3 a 5 anos</label><select id="infantil-3-5" class="input-control" multiple></select></div>
                <div class="input-group"><label for="infantil-6-8">6 a 8 anos</label><select id="infantil-6-8" class="input-control" multiple></select></div>
                <div class="input-group"><label for="infantil-9-12">9 a 12 anos</label><select id="infantil-9-12" class="input-control" multiple></select></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalEscala()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar Escala</button>
            </div>
        </form>
    </div>
</div>
    <div id="toast-container"></div>
    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE (CORRIGIDO) ---
        const SUPABASE_URL = 'https://wzzyxbkhmlfilvlihvvl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable__r9k3LzISUD3NwICOhOklw_mf1IprWw';
    
        // Criando o cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // --- 2. ESTADO GLOBAL ---
        let estado = {
            cultos: [],
            escalas: [],
            membros: [],
            charts: {},
            theme: localStorage.getItem('app-theme') || 'light'
        };
        // --- 3. INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Aplica tema
            document.body.setAttribute('data-theme', estado.theme);
            document.getElementById('theme-toggle').checked = estado.theme === 'dark';
        
            cacheDOM();
            bindEvents();
        
            // Tenta a conexão e carrega os dados
            await checkConnection();
            await carregarDados();
        
            document.getElementById('loading-overlay').style.display = 'none';
        });
        // --- 4. FUNÇÕES DE CONEXÃO E DADOS ---
        async function checkConnection() {
            const statusEl = document.getElementById('connection-status');
            statusEl.classList.remove('status-error');
            statusEl.classList.add('status-ok');
            statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> Testando Conexão...';
        
            try {
                // Tenta fazer uma consulta simples para validar a conexão
                const { error } = await supabase.from('cultos').select('id', { count: 'exact', head: true });
            
                if (error) throw error;
            
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Supabase Conectado';
                statusEl.classList.remove('status-error');
                statusEl.classList.add('status-ok');
            } catch (e) {
                console.error("Erro na conexão Supabase:", e);
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro de Conexão';
                statusEl.classList.remove('status-ok');
                statusEl.classList.add('status-error');
                mostrarToast("Falha ao conectar ao banco de dados.", "error");
            }
        }
        async function carregarDados() {
            document.getElementById('loading-text').innerText = "Carregando dados...";
        
            try {
                const [resCultos, resEscalas, resMembros] = await Promise.all([
                    supabase.from('cultos').select('*').order('data_culto', { ascending: false }),
                    supabase.from('escalas').select('*'),
                    supabase.from('membros').select('*').order('nome')
                ]);
                estado.cultos = resCultos.data || [];
                estado.escalas = resEscalas.data || [];
                estado.membros = resMembros.data || [];
                populateDepartamentosSelects();
                atualizarUI();
            
            } catch (err) {
                console.error("Erro ao carregar dados:", err);
                mostrarToast('Erro ao carregar dados do servidor.', 'error');
            }
        }
        async function salvarCulto(e) {
            e.preventDefault();
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Salvando Culto...";
        
            const novoCulto = {
                data_culto: document.getElementById('data-culto').value,
                dia_semana: document.getElementById('dia-semana').value,
                tipo_culto: document.getElementById('tipo-culto').value,
                hora_inicio: document.getElementById('hora-inicio').value,
                hora_termino: document.getElementById('hora-termino').value,
                tempo_ministerio: parseInt(document.getElementById('tempo-ministerio').value) || 0,
                homens: parseInt(document.getElementById('homens').value) || 0,
                mulheres: parseInt(document.getElementById('mulheres').value) || 0,
                criancas: parseInt(document.getElementById('criancas').value) || 0,
                ministro: document.getElementById('ministro').value,
                dirigente: document.getElementById('dirigente').value,
                observacoes: document.getElementById('observacoes').value
            };
            try {
                // 1. Salvar Culto
                const { data: culto, error } = await supabase.from('cultos').insert(novoCulto).select().single();
                if (error) throw error;
                // 2. Salvar Escalas
                const escalasInputs = [
                    { dept: 'Diaconato', id: 'diaconato' },
                    { dept: 'Infantil', id: 'infantil' },
                    { dept: 'Música', id: 'musica' },
                    { dept: 'Mídia', id: 'midia' },
                    { dept: 'Recepção', id: 'recepcao' },
                    { dept: 'Jovens', id: 'jovens' },
                    { dept: 'Transito', id: 'transito' },
                    { dept: 'Concelheiros', id: 'concelheiros' },
                    { dept: 'Livraria', id: 'livraria' },
                    { dept: 'Ministros', id: 'ministros' }
                ];
                const escalasParaSalvar = escalasInputs
                    .map(s => ({
                        dept: s.dept,
                        val: Array.from(document.getElementById(s.id).selectedOptions).map(opt => opt.value).join(', ')
                    }))
                    .filter(s => s.val && s.val.trim() !== "")
                    .map(s => ({
                        culto_id: culto.id,
                        data_escala: novoCulto.data_culto,
                        departamento: s.dept,
                        nomes: s.val
                    }));
                if (escalasParaSalvar.length > 0) {
                    const { error: errorEscalas } = await supabase.from('escalas').insert(escalasParaSalvar);
                    if (errorEscalas) throw errorEscalas;
                }
                mostrarToast('Culto registrado com sucesso!', 'success');
                document.getElementById('culto-form').reset();
                document.getElementById('total-presentes').value = 0;
            
                // Recarregar e navegar
                await carregarDados();
                document.getElementById('dashboard-tab').click();
            } catch (error) {
                console.error("Erro ao salvar:", error);
                mostrarToast('Erro ao salvar no banco de dados.', 'error');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
    
        async function deletarCulto(id) {
            if(!confirm('Tem certeza que deseja excluir este registro?')) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Excluindo registro...";
        
            try {
                const { error } = await supabase.from('cultos').delete().eq('id', id);
                if (error) throw error;
            
                mostrarToast('Culto removido com sucesso.', 'success');
                await carregarDados();
            } catch (err) {
                mostrarToast('Erro ao deletar: ' + err.message, 'error');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        async function salvarMembro(e) {
    e.preventDefault();
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('loading-text').innerText = "Salvando membro...";
    const id = document.getElementById('membro-id').value;
    const nome = document.getElementById('membro-nome').value.trim();
    const telefone = document.getElementById('membro-telefone').value.trim();
    const nascimento = document.getElementById('membro-nascimento').value || null;
    const email = document.getElementById('membro-email').value.trim() || null;
    const fez_rhema = document.getElementById('membro-rhema').value === 'true';
    const escola_ministros = document.getElementById('membro-escola').value === 'true';
    const deptos = Array.from(document.getElementById('membro-departamentos').selectedOptions).map(opt => opt.value);
    try {
        let error;
        if (id) {
            // Atualizar membro existente
            ({ error } = await supabase.from('membros').update({
                nome,
                telefone,
                nascimento,
                email,
                departamentos: deptos,
                fez_rhema,
                escola_ministros
            }).eq('id', id));
            mostrarToast('Membro atualizado com sucesso!', 'success');
        } else {
            // Inserir novo membro
            ({ error } = await supabase.from('membros').insert({
                nome,
                telefone,
                nascimento,
                email,
                departamentos: deptos,
                fez_rhema,
                escola_ministros
            }));
            mostrarToast('Membro cadastrado com sucesso!', 'success');
        }
        if (error) throw error;
        fecharModalMembro();
        await carregarDados(); // recarrega tudo
    } catch (err) {
        mostrarToast('Erro ao salvar membro: ' + err.message, 'error');
    } finally {
        document.getElementById('loading-overlay').style.display = 'none';
    }
}
function fecharModalMembro() {
    document.getElementById('modal-membro').style.display = 'none';
    document.getElementById('form-membro').reset();
    document.getElementById('membro-id').value = '';
}
function editarMembro(id) {
    const membro = estado.membros.find(m => m.id === id);
    if (!membro) return;
    document.getElementById('membro-id').value = membro.id;
    document.getElementById('membro-nome').value = membro.nome;
    document.getElementById('membro-telefone').value = membro.telefone || '';
    document.getElementById('membro-nascimento').value = membro.nascimento || '';
    document.getElementById('membro-email').value = membro.email || '';
    document.getElementById('membro-rhema').value = membro.fez_rhema ? 'true' : 'false';
    document.getElementById('membro-escola').value = membro.escola_ministros ? 'true' : 'false';
    const select = document.getElementById('membro-departamentos');
    Array.from(select.options).forEach(opt => {
        opt.selected = membro.departamentos && membro.departamentos.includes(opt.value);
    });
    document.getElementById('modal-membro').style.display = 'flex';
}
        async function deletarMembro(id) {
            if(!confirm('Excluir membro? Esta ação é permanente.')) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Excluindo membro...";
        
            try {
                const { error } = await supabase.from('membros').delete().eq('id', id);
                if (!error) {
                    mostrarToast('Membro excluído', 'success');
                    await carregarDados();
                } else {
                    throw error;
                }
            } catch(err) {
                 mostrarToast('Erro ao excluir: ' + err.message, 'error');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        // --- 5. RENDERIZAÇÃO DA UI ---
        function atualizarUI() {
            renderDashboard();
            renderHistorico();
            renderEscalas();
            renderMembros();
            updateBadges();
        }
        function renderDashboard() {
            const totalCultos = estado.cultos.length;
            const totalPublico = estado.cultos.reduce((acc, c) => acc + (c.homens + c.mulheres + c.criancas), 0);
            const mediaPublico = totalCultos > 0 ? Math.round(totalPublico / totalCultos) : 0;
            const totalMembros = estado.membros.length;
        
            // Cards
            document.getElementById('dashboard-cards').innerHTML = `
                <div class="card card-info">
                    <div class="card-header">
                        <div class="card-title">Média de Público</div>
                        <div class="card-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="card-value">${mediaPublico}</div>
                    <div class="card-subvalue">Por culto (Total: ${totalPublico})</div>
                </div>
                <div class="card card-success">
                    <div class="card-header">
                        <div class="card-title">Cultos Registrados</div>
                        <div class="card-icon"><i class="fas fa-church"></i></div>
                    </div>
                    <div class="card-value">${totalCultos}</div>
                    <div class="card-subvalue">Registros em todo o histórico</div>
                </div>
                <div class="card card-warning">
                    <div class="card-header">
                        <div class="card-title">Base de Membros</div>
                        <div class="card-icon"><i class="fas fa-user-check"></i></div>
                    </div>
                    <div class="card-value">${totalMembros}</div>
                    <div class="card-subvalue">${estado.membros.filter(m => m.ativo).length} ativos</div>
                </div>
            `;
            renderCharts();
            renderTimeline();
        }
        function renderTimeline() {
            const tbody = document.getElementById('timeline-events');
        
            // Renderiza apenas os 5 últimos cultos
            tbody.innerHTML = estado.cultos.slice(0, 5).map(c => `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:15px; font-weight:500;">${new Date(c.data_culto).toLocaleDateString('pt-BR')}</td>
                    <td style="padding:15px;">${c.tipo_culto}</td>
                    <td style="padding:15px; font-weight:bold; color:var(--primary);">${c.homens+c.mulheres+c.criancas}</td>
                    <td style="padding:15px;">${c.ministro}</td>
                </tr>
            `).join('');
        }
        function renderCharts() {
            // Gráfico 1: Crescimento (Linha)
            const ultimosCultos = [...estado.cultos].slice(0, 10).reverse();
            const labels = ultimosCultos.map(c => new Date(c.data_culto).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
            const dataTotal = ultimosCultos.map(c => c.homens + c.mulheres + c.criancas);
            const ctxGrowth = document.getElementById('growthChart').getContext('2d');
            if(estado.charts.growth) estado.charts.growth.destroy();
            estado.charts.growth = new Chart(ctxGrowth, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Público Total',
                        data: dataTotal,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(26, 95, 180, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            // Gráfico 2: Demográfico (Barra)
            const totalH = estado.cultos.reduce((a,c)=>a+c.homens,0);
            const totalM = estado.cultos.reduce((a,c)=>a+c.mulheres,0);
            const totalC = estado.cultos.reduce((a,c)=>a+c.criancas,0);
        
            const ctxDemo = document.getElementById('demographicsChart').getContext('2d');
            if(estado.charts.demo) estado.charts.demo.destroy();
            estado.charts.demo = new Chart(ctxDemo, {
                type: 'bar',
                data: {
                    labels: ['Homens', 'Mulheres', 'Crianças'],
                    datasets: [{
                        label: 'Total Acumulado',
                        data: [totalH, totalM, totalC],
                        backgroundColor: ['#3498db', '#e91e63', '#27ae60'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        function renderHistorico() {
            const container = document.getElementById('historico-table-container');
            if(!container) return;
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:2px solid var(--border-color); text-align:left; background-color: var(--bg-main);">
                                <th style="padding:15px;">Data</th>
                                <th style="padding:15px;">Tipo</th>
                                <th style="padding:15px;">Público</th>
                                <th style="padding:15px;">Ministro</th>
                                <th style="padding:15px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estado.cultos.map(c => `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:15px;">${new Date(c.data_culto).toLocaleDateString('pt-BR')}</td>
                                    <td style="padding:15px;">${c.tipo_culto}</td>
                                    <td style="padding:15px;"><strong>${c.homens+c.mulheres+c.criancas}</strong></td>
                                    <td style="padding:15px;">${c.ministro}</td>
                                    <td style="padding:15px;">
                                        <button class="btn" style="color:var(--danger); background:none; border:none; padding:0;" onclick="deletarCulto(${c.id})"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        function renderEscalas() {
            const container = document.getElementById('lista-escalas');
            if(!container) return;
        
            container.innerHTML = '';
            const filtroData = document.getElementById('filtro-data-escala')?.value || '';
            const escalasFiltradas = filtroData ? estado.escalas.filter(e => e.data_escala === filtroData) : estado.escalas;
            // Group by date
            const groups = {};
            escalasFiltradas.forEach(e => {
              const date = e.data_escala;
              if (!date) return;
              if (!groups[date]) groups[date] = { escalas: [] };
              groups[date].escalas.push(e);
            });
            const sortedDates = Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).slice(0, filtroData ? undefined : 6);
            sortedDates.forEach(date => {
              const g = groups[date];
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `
                  <div style="font-weight:600; margin-bottom:10px; color:var(--primary); border-bottom:1px solid var(--border-color); padding-bottom:5px;">
                      ${new Date(date).toLocaleDateString('pt-BR')} - Escala
                      <button class="btn btn-secondary" style="float:right; padding:5px 10px;" onclick="editarEscala('${date}')"><i class="fas fa-edit"></i> Editar</button>
                  </div>
                  ${g.escalas.map(e => `
                      <div style="font-size:0.9rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                          <span style="font-weight:600; color:var(--gray);">${e.departamento}:</span>
                          <span style="max-width: 60%; text-align: right;">${e.nomes}</span>
                      </div>
                  `).join('')}
              `;
              container.appendChild(card);
            });
        }
    
        function calcularIdade(dataNasc) {
    if (!dataNasc) return '';
    const [y, m, d] = dataNasc.split('-').map(Number);
    const nasc = new Date(y, m - 1, d);
    const hoje = new Date();
    let idade = hoje.getFullYear() - nasc.getFullYear();
    const monthDiff = hoje.getMonth() - nasc.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && hoje.getDate() < nasc.getDate())) idade--;
    return idade;
}
function ehAniversarianteDoMes(dataNasc) {
    if (!dataNasc) return false;
    const [y, m, d] = dataNasc.split('-').map(Number);
    const nasc = new Date(y, m - 1, d);
    const hoje = new Date();
    return hoje.getMonth() === nasc.getMonth();
}
function renderMembros() {
    const container = document.getElementById('membros-table-container');
    if (!container) return;
    // Aplicar filtros
    let membrosFiltrados = [...estado.membros];
    const filtroNome = document.getElementById('filtro-nome')?.value.toLowerCase() || '';
    const filtroDepto = document.getElementById('filtro-departamento')?.value || '';
    const filtroAniv = document.getElementById('filtro-aniversario')?.value || '';
    const filtroRhema = document.getElementById('filtro-rhema')?.value;
    const filtroEscolaMinistros = document.getElementById('filtro-escola-ministros')?.value;
    if (filtroNome) {
        membrosFiltrados = membrosFiltrados.filter(m => m.nome.toLowerCase().includes(filtroNome));
    }
    if (filtroDepto) {
        membrosFiltrados = membrosFiltrados.filter(m =>
            m.departamentos && m.departamentos.some(d => d.includes(filtroDepto))
        );
    }
    if (filtroAniv === 'sim') {
        membrosFiltrados = membrosFiltrados.filter(m => ehAniversarianteDoMes(m.nascimento));
    }
    if (filtroRhema !== '') {
        membrosFiltrados = membrosFiltrados.filter(m => String(m.fez_rhema) === filtroRhema);
    }
    if (filtroEscolaMinistros !== '') {
        membrosFiltrados = membrosFiltrados.filter(m => String(m.escola_ministros) === filtroEscolaMinistros);
    }
    container.innerHTML = `
        <div style="margin-bottom:15px; font-weight:600; color:var(--primary);">
            Mostrando ${membrosFiltrados.length} de ${estado.membros.length} membros
            ${filtroAniv === 'sim' ? ' — Aniversariantes do mês' : ''}
        </div>
        <div class="table-responsive">
            <table class="table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:var(--bg-main); text-align:left;">
                        <th style="padding:15px;">Nome</th>
                        <th style="padding:15px;">Idade / Aniversário</th>
                        <th style="padding:15px;">Telefone</th>
                        <th style="padding:15px;">Departamentos</th>
                        <th style="padding:15px;">Rhema / Ministros</th>
                        <th style="padding:15px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${membrosFiltrados.map(m => {
                        const idade = calcularIdade(m.nascimento);
                        const anivStyle = ehAniversarianteDoMes(m.nascimento) ? 'color:var(--success); font-weight:bold;' : '';
                        const iconAniv = ehAniversarianteDoMes(m.nascimento) ? ' Festa' : '';
                        let birthDisplay = '-';
                        if (m.nascimento) {
                            const [y, month, day] = m.nascimento.split('-').map(Number);
                            const nasc = new Date(y, month - 1, day);
                            birthDisplay = nasc.toLocaleDateString('pt-BR', {day: '2-digit', month: 'long'});
                        }
                        return `
                            <tr style="border-bottom:1px solid var(--border-color); ${ehAniversarianteDoMes(m.nascimento) ? 'background:rgba(39,174,96,0.1);' : ''}">
                                <td style="padding:15px;">${m.nome} ${iconAniv}</td>
                                <td style="padding:15px; ${anivStyle}">
                                    ${birthDisplay}
                                    ${idade ? ` (${idade} anos)` : ''}
                                </td>
                                <td style="padding:15px;">${m.telefone || '-'}</td>
                                <td style="padding:15px; font-size:0.9rem;">
                                    ${m.departamentos && m.departamentos.length > 0 ? m.departamentos.join(', ') : '<em style="color:var(--gray)">Sem departamento</em>'}
                                </td>
                                <td style="padding:15px;">
                                    ${m.fez_rhema ? 'Rhema' : ''}
                                    ${m.escola_ministros ? 'Ministros' : ''}
                                    ${!m.fez_rhema && !m.escola_ministros ? '-' : ''}
                                </td>
                                <td style="padding:15px;">
                                    <button class="btn" style="color:var(--primary); background:none; border:none; margin-right:10px;" onclick="editarMembro(${m.id})">
                                        Editar
                                    </button>
                                    <button class="btn" style="color:var(--danger); background:none; border:none;" onclick="deletarMembro(${m.id})">
                                        Excluir
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    // Adicionar eventos aos filtros (debounce simples)
    ['filtro-nome', 'filtro-departamento', 'filtro-aniversario', 'filtro-rhema', 'filtro-escola-ministros'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.oninput = el.onchange = () => renderMembros();
    });
}
        // --- 6. FUNÇÕES AUXILIARES E EVENTOS ---
        function cacheDOM() {
            // Formulários
            const formCulto = document.getElementById('culto-form');
            if(formCulto) formCulto.addEventListener('submit', salvarCulto);
            const formMembro = document.getElementById('form-membro');
            if(formMembro) formMembro.addEventListener('submit', salvarMembro);
            const formEscala = document.getElementById('form-escala');
            if(formEscala) formEscala.addEventListener('submit', salvarEscala);
            // Soma automática
            ['homens', 'mulheres', 'criancas'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', calcularTotal);
            });
            // Data de hoje
            const dateInput = document.getElementById('data-culto');
            if(dateInput) dateInput.valueAsDate = new Date();
            const dateEscala = document.getElementById('data-escala');
            if(dateEscala) dateEscala.valueAsDate = new Date();
        }
        function bindEvents() {
            // Navegação por Tabs
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // UI de Navegação
                    document.querySelectorAll('.nav-menu a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                
                    // UI de Conteúdo
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    const targetId = link.getAttribute('href').substring(1);
                    document.getElementById(targetId).classList.add('active');
                
                    // Atualiza título
                    document.getElementById('current-title').innerText = link.innerText.split(" ")[0];
                    // Fecha sidebar no mobile
                    if(window.innerWidth < 992) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                
                    // Re-renderiza gráficos ao voltar pro dashboard
                    if(targetId === 'dashboard') renderCharts();
                });
            });
            // Mobile toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }
        function calcularTotal() {
            const h = parseInt(document.getElementById('homens').value) || 0;
            const m = parseInt(document.getElementById('mulheres').value) || 0;
            const c = parseInt(document.getElementById('criancas').value) || 0;
            document.getElementById('total-presentes').value = h + m + c;
        }
        function updateBadges() {
            document.getElementById('dashboard-badge').innerText = estado.cultos.length;
            document.getElementById('historico-badge').innerText = estado.cultos.length;
        }
        function populateDepartamentosSelects() {
            const deptMap = {
                diaconato: 'Diaconato',
                infantil: 'Infantil',
                musica: 'Música',
                midia: 'Mídia',
                recepcao: 'Recepção',
                jovens: 'Jovens',
                transito: 'Transito',
                concelheiros: 'Concelheiros',
                livraria: 'Livraria',
                ministros: 'Ministros'
            };
            Object.keys(deptMap).forEach(deptId => {
                const select = document.getElementById(deptId);
                if (!select) return;
                select.innerHTML = '';
                const deptName = deptMap[deptId];
                const membrosDept = estado.membros.filter(m => m.departamentos && m.departamentos.includes(deptName));
                membrosDept.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.nome;
                    opt.text = m.nome;
                    select.appendChild(opt);
                });
            });
            const escalaDeptMap = {
                'diaconato-escala': 'Diaconato',
                'musica-escala': 'Música',
                'midia-escala': 'Mídia',
                'recepcao-escala': 'Recepção',
                'jovens-escala': 'Jovens',
                'transito-escala': 'Transito',
                'concelheiros-escala': 'Concelheiros',
                'livraria-escala': 'Livraria',
                'ministros-escala': 'Ministros',
                'infantil-0-2': 'Infantil',
                'infantil-3-5': 'Infantil',
                'infantil-6-8': 'Infantil',
                'infantil-9-12': 'Infantil'
            };
            Object.keys(escalaDeptMap).forEach(deptId => {
                const select = document.getElementById(deptId);
                if (!select) return;
                select.innerHTML = '';
                const deptName = escalaDeptMap[deptId];
                const membrosDept = estado.membros.filter(m => m.departamentos && m.departamentos.includes(deptName));
                membrosDept.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.nome;
                    opt.text = m.nome;
                    select.appendChild(opt);
                });
            });
        }
    
        // --- Settings Functions ---
        window.toggleDarkMode = (isDark) => {
            const newTheme = isDark ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            estado.theme = newTheme;
            localStorage.setItem('app-theme', newTheme);
            if(estado.charts.growth) renderCharts(); // Atualiza gráficos para novo tema
        };
        window.exportData = () => {
            const dataToExport = estado.cultos.map(c => ({
                Data: new Date(c.data_culto).toLocaleDateString('pt-BR'),
                Tipo: c.tipo_culto,
                Total_Publico: c.homens + c.mulheres + c.criancas,
                Homens: c.homens,
                Mulheres: c.mulheres,
                Crianças: c.criancas,
                Ministro: c.ministro,
                Dirigente: c.dirigente,
                Observações: c.observacoes
            }));
            const headers = Object.keys(dataToExport[0]);
            const csv = [
                headers.join(';'),
                ...dataToExport.map(row => headers.map(header => row[header]).join(';'))
            ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `cultos_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        
            mostrarToast('Dados exportados para CSV!', 'success');
        };
        window.logout = () => {
            if (confirm('Deseja sair do sistema?')) {
                mostrarToast('Saindo...', 'info');
                setTimeout(() => window.location.reload(), 500);
            }
        };
        // --- Modals and Toast ---
        window.openModalMembro = () => {
            document.getElementById('modal-membro').style.display='flex';
        };
        window.openModalEscala = () => {
            document.getElementById('modal-escala').style.display='flex';
        };
        window.fecharModalEscala = () => {
            document.getElementById('modal-escala').style.display = 'none';
            document.getElementById('form-escala').reset();
            document.getElementById('edit-date').value = '';
        };
        window.mostrarToast = (msg, tipo) => {
            const t = document.createElement('div');
            t.className = `toast toast-${tipo}`;
            t.innerHTML = tipo === 'success' ? `<i class="fas fa-check-circle"></i> ${msg}` : `<i class="fas fa-exclamation-triangle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        };
        async function salvarEscala(e) {
            e.preventDefault();
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Salvando Escala...";
            const data_escala = document.getElementById('data-escala').value;
            if (!data_escala) {
                mostrarToast('Data obrigatória', 'error');
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }
            const editDate = document.getElementById('edit-date').value;
            try {
                if (editDate) {
                    const { error: deleteError } = await supabase.from('escalas').delete().eq('data_escala', editDate);
                    if (deleteError) throw deleteError;
                }
                const escalasInputs = [
                    { dept: 'Diaconato', id: 'diaconato-escala' },
                    { dept: 'Música', id: 'musica-escala' },
                    { dept: 'Mídia', id: 'midia-escala' },
                    { dept: 'Recepção', id: 'recepcao-escala' },
                    { dept: 'Jovens', id: 'jovens-escala' },
                    { dept: 'Transito', id: 'transito-escala' },
                    { dept: 'Concelheiros', id: 'concelheiros-escala' },
                    { dept: 'Livraria', id: 'livraria-escala' },
                    { dept: 'Ministros', id: 'ministros-escala' },
                    { dept: 'Infantil 0-2', id: 'infantil-0-2' },
                    { dept: 'Infantil 3-5', id: 'infantil-3-5' },
                    { dept: 'Infantil 6-8', id: 'infantil-6-8' },
                    { dept: 'Infantil 9-12', id: 'infantil-9-12' }
                ];
                const escalasParaSalvar = escalasInputs
                    .map(s => ({
                        dept: s.dept,
                        val: Array.from(document.getElementById(s.id).selectedOptions).map(opt => opt.value).join(', ')
                    }))
                    .filter(s => s.val && s.val.trim() !== "")
                    .map(s => ({
                        data_escala,
                        departamento: s.dept,
                        nomes: s.val
                    }));
                if (escalasParaSalvar.length > 0) {
                    const { error } = await supabase.from('escalas').insert(escalasParaSalvar);
                    if (error) throw error;
                }
                mostrarToast('Escala salva com sucesso!', 'success');
                document.getElementById('edit-date').value = '';
                fecharModalEscala();
                await carregarDados();
            } catch (error) {
                console.error("Erro ao salvar escala:", error);
                mostrarToast('Erro ao salvar no banco de dados.', 'error');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        function editarEscala(date) {
            document.getElementById('modal-escala').style.display = 'flex';
            document.getElementById('data-escala').value = date;
            document.getElementById('edit-date').value = date;
            // Reset selects
            const selects = document.querySelectorAll('#form-escala select');
            selects.forEach(s => {
                Array.from(s.options).forEach(o => o.selected = false);
            });
            // Load existing
            const escalasDate = estado.escalas.filter(e => e.data_escala === date);
            escalasDate.forEach(e => {
                let deptId;
                switch(e.departamento) {
                    case 'Diaconato': deptId = 'diaconato-escala'; break;
                    case 'Música': deptId = 'musica-escala'; break;
                    case 'Mídia': deptId = 'midia-escala'; break;
                    case 'Recepção': deptId = 'recepcao-escala'; break;
                    case 'Jovens': deptId = 'jovens-escala'; break;
                    case 'Transito': deptId = 'transito-escala'; break;
                    case 'Concelheiros': deptId = 'concelheiros-escala'; break;
                    case 'Livraria': deptId = 'livraria-escala'; break;
                    case 'Ministros': deptId = 'ministros-escala'; break;
                    case 'Infantil 0-2': deptId = 'infantil-0-2'; break;
                    case 'Infantil 3-5': deptId = 'infantil-3-5'; break;
                    case 'Infantil 6-8': deptId = 'infantil-6-8'; break;
                    case 'Infantil 9-12': deptId = 'infantil-9-12'; break;
                }
                if (deptId) {
                    const select = document.getElementById(deptId);
                    const nomes = e.nomes.split(', ');
                    Array.from(select.options).forEach(opt => {
                        if (nomes.includes(opt.value)) opt.selected = true;
                    });
                }
            });
        }
// Máscara de telefone
document.getElementById('membro-telefone')?.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
    v = v.replace(/(\d)(\d{4})$/, '$1-$2');
    e.target.value = v;
});
    </script>
</body>
</html>
