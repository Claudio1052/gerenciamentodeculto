<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Cultos - Verbo da Vida Zona Leste</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a5fb4;
            --primary-dark: #0d4a8a;
            --secondary: #e67e22;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #f5f7fa; color: var(--dark); line-height: 1.6; }
        .container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 250px; background-color: var(--primary); color: white; padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; transition: transform 0.3s ease; }
        .logo { padding: 0 20px 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
        .logo h1 { font-family: 'Poppins', sans-serif; font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .logo p { font-size: 0.9rem; opacity: 0.8; }
        .nav-menu { list-style: none; }
        .nav-menu li { margin-bottom: 5px; }
        .nav-menu a { display: flex; align-items: center; padding: 15px 20px; color: white; text-decoration: none; transition: all 0.3s; }
        .nav-menu a:hover, .nav-menu a.active { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid var(--secondary); }
        .nav-menu i { margin-right: 10px; width: 20px; text-align: center; }

        /* Main Content */
        .main-content { flex: 1; margin-left: 250px; padding: 20px; transition: margin-left 0.3s ease; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); }
        .header-title h2 { font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--primary); font-size: 1.8rem; }
        .header-title p { color: var(--gray); font-size: 0.95rem; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Cards */
        .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 1rem; color: var(--gray); font-weight: 500; }
        .card-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .icon-blue { background-color: rgba(26, 95, 180, 0.1); color: var(--primary); }
        .icon-green { background-color: rgba(40, 167, 69, 0.1); color: var(--success); }
        .icon-orange { background-color: rgba(230, 126, 34, 0.1); color: var(--secondary); }
        .card-value { font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .card-change { font-size: 0.85rem; }
        .positive { color: var(--success); }

        /* Sections */
        .section { background-color: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 30px; }
        .section-title { font-family: 'Poppins', sans-serif; font-size: 1.4rem; font-weight: 600; color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--light-gray); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: var(--border-radius); font-size: 1rem; transition: border 0.3s; }
        .form-control:focus { outline: none; border-color: var(--primary); }
        .btn { padding: 12px 25px; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        
        /* Tables */
        .table-responsive { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background-color: var(--light-gray); padding: 15px; text-align: left; font-weight: 600; color: var(--dark); }
        .table td { padding: 15px; border-bottom: 1px solid var(--light-gray); }
        .table tr:hover { background-color: #f9f9f9; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: rgba(40, 167, 69, 0.1); color: var(--success); }
        .badge-warning { background-color: rgba(255, 193, 7, 0.1); color: #e0a800; }

        /* Charts */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-container { background-color: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); }

        /* Tabs & Stats */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; font-size: 1rem; font-weight: 500; color: var(--gray); cursor: pointer; position: relative; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 5px; }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
            .sidebar.active { transform: translateX(0); }
            .main-content.active { margin-left: 250px; }
            .menu-toggle { display: block; }
        }
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; margin-right: 15px; }

        /* Utilities */
        .escalados-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .escalado-card { background-color: var(--light); border-radius: var(--border-radius); padding: 15px; border-left: 4px solid var(--primary); }
        
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid var(--primary); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast & Modal */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; border-radius: var(--border-radius); color: white; font-weight: 500; z-index: 1000; animation: slideIn 0.3s ease; max-width: 400px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { background-color: var(--success); }
        .toast-error { background-color: var(--danger); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; border-radius: var(--border-radius); padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }

        .connection-status {
            position: fixed; bottom: 5px; right: 5px; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; z-index: 2000;
        }
        .status-ok { background-color: var(--success); color: white; }
        .status-error { background-color: var(--danger); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
        </div>
        
        <div id="connection-status" class="connection-status" style="display:none;"></div>

        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <h1>Verbo da Vida</h1>
                <p>Zona Leste - Gestão</p>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="active" id="dashboard-tab"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#registro" id="registro-tab"><i class="fas fa-plus-circle"></i> Novo Culto</a></li>
                <li><a href="#historico" id="historico-tab"><i class="fas fa-history"></i> Histórico</a></li>
                <li><a href="#escalas" id="escalas-tab"><i class="fas fa-users"></i> Escalas</a></li>
                <li><a href="#membros" id="membros-tab"><i class="fas fa-address-book"></i> Membros</a></li>
                <li><a href="#relatorios" id="relatorios-tab"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
                <li><a href="#configuracoes" id="configuracoes-tab"><i class="fas fa-cog"></i> Configurações</a></li>
            </ul>
        </nav>

        <main class="main-content" id="main-content">
            <header>
                <div class="header-left" style="display:flex; align-items:center;">
                    <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
                    <div class="header-title">
                        <h2 id="page-title">Dashboard</h2>
                        <p id="page-subtitle">Visão geral do ministério</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar">AD</div>
                </div>
            </header>

            <section id="dashboard" class="tab-content active">
                <div class="cards-container" id="dashboard-cards">
                    </div>
                <div class="charts-container">
                    <div class="chart-container">
                        <h3 class="chart-title">Frequência por Tipo</h3>
                        <canvas id="cultoTypeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Demografia (Média)</h3>
                        <canvas id="demographicsChart"></canvas>
                    </div>
                </div>
                <div class="section">
                    <h3 class="section-title">Últimos Cultos</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Data</th><th>Dia</th><th>Tipo</th><th>Público</th><th>Ministro</th><th>Ações</th></tr></thead>
                            <tbody id="ultimos-cultos"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="registro" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Registrar Novo Culto</h3>
                    <form id="culto-form">
                        <div class="form-row">
                            <div class="form-group"><label>Data</label><input type="date" id="data-culto" class="form-control" required></div>
                            <div class="form-group"><label>Dia</label>
                                <select id="dia-semana" class="form-control" required>
                                    <option value="terca">Terça-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="domingo">Domingo</option>
                                    <option value="sabado">Sábado</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Tipo</label>
                                <select id="tipo-culto" class="form-control" required>
                                    <option value="Culto da Família">Culto da Família</option>
                                    <option value="Culto de Jovens">Culto de Jovens</option>
                                    <option value="Culto de Oração">Culto de Oração</option>
                                    <option value="Santa Ceia">Santa Ceia</option>
                                    <option value="Especial">Especial</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Início</label><input type="time" id="hora-inicio" class="form-control" required></div>
                            <div class="form-group"><label>Término</label><input type="time" id="hora-termino" class="form-control" required></div>
                            <div class="form-group"><label>Tempo Palavra (min)</label><input type="number" id="tempo-ministerio" class="form-control" value="60"></div>
                        </div>
                        <h4 style="margin: 20px 0 10px; color:var(--primary);">Público</h4>
                        <div class="form-row">
                            <div class="form-group"><label>Homens</label><input type="number" id="homens" class="form-control" value="0"></div>
                            <div class="form-group"><label>Mulheres</label><input type="number" id="mulheres" class="form-control" value="0"></div>
                            <div class="form-group"><label>Crianças</label><input type="number" id="criancas" class="form-control" value="0"></div>
                            <div class="form-group"><label>Total</label><input type="number" id="total-presentes" class="form-control" readonly></div>
                        </div>
                        <h4 style="margin: 20px 0 10px; color:var(--primary);">Liderança & Equipes</h4>
                        <div class="form-row">
                            <div class="form-group"><label>Ministro</label><input type="text" id="ministro" class="form-control" required></div>
                            <div class="form-group"><label>Dirigente</label><input type="text" id="dirigente" class="form-control" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Diaconato</label><input type="text" id="diaconato" class="form-control" placeholder="Nomes..."></div>
                            <div class="form-group"><label>Infantil</label><input type="text" id="infantil" class="form-control" placeholder="Nomes..."></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Música</label><input type="text" id="musica" class="form-control" placeholder="Nomes..."></div>
                            <div class="form-group"><label>Mídia</label><input type="text" id="midia" class="form-control" placeholder="Nomes..."></div>
                        </div>
                        <div class="form-group"><label>Observações</label><textarea id="observacoes" class="form-control" rows="2"></textarea></div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Registrar</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="historico" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Histórico Completo</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Data</th><th>Tipo</th><th>Total</th><th>Início</th><th>Ministro</th><th>Ações</th></tr></thead>
                            <tbody id="historico-cultos"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="escalas" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Escalas</h3>
                    <div class="escalados-list" id="lista-escalas"></div>
                </div>
            </section>

            <section id="membros" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Membros</h3>
                    <button class="btn btn-primary" id="btn-novo-membro" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Novo Membro</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Nome</th><th>Email</th><th>Depto</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="lista-membros"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="relatorios" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Analytics</h3>
                    <div class="stats-grid" id="relatorios-stats"></div>
                </div>
            </section>

            <section id="configuracoes" class="tab-content">
                <div class="section">
                    <h3 class="section-title">Configurações</h3>
                    <form id="config-form">
                        <div class="form-group">
                            <label>Nome da Igreja</label>
                            <input type="text" id="nome-igreja" class="form-control" placeholder="Nome da Igreja">
                        </div>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="modal-detalhes">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Detalhes</h3><button class="modal-close">&times;</button></div>
            <div id="modal-detalhes-content"></div>
        </div>
    </div>

    <div class="modal" id="modal-membro">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-membro-title">Membro</h3><button class="modal-close" id="modal-membro-close">&times;</button></div>
            <form id="form-membro">
                <input type="hidden" id="membro-id">
                <div class="form-group"><label>Nome</label><input type="text" id="membro-nome" class="form-control" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="membro-email" class="form-control"></div>
                <div class="form-group"><label>Departamentos (separar por vírgula)</label><input type="text" id="membro-departamentos" class="form-control"></div>
                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE ---
        // AVISO: Se a chave fornecida não for a chave 'anon' pública (JWT), pode ocorrer erro de autenticação.
        // Geralmente a chave começa com "eyJ...". Use a chave do Dashboard > Settings > API > anon public.
        const SUPABASE_URL = 'https://wzzyxbkhmlfilvlihvvl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable__r9k3LzISUD3NwICOhOklw_mf1IprWw'; 
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Estado Global
        let estado = { cultos: [], escalas: [], membros: [], configs: {}, charts: {} };
        
        // Elementos DOM (Cache)
        const els = {};

        document.addEventListener('DOMContentLoaded', async () => {
            cacheDOM();
            bindEvents();
            
            // Verificação de conexão simples
            try {
                const { data, error } = await supabase.from('cultos').select('count', { count: 'exact', head: true });
                const statusEl = document.getElementById('connection-status');
                statusEl.style.display = 'block';
                if (error) {
                    console.error("Erro Supabase:", error);
                    statusEl.textContent = "Erro Conexão Supabase (Verifique Console)";
                    statusEl.className = "connection-status status-error";
                    mostrarToast("Erro de conexão com Banco de Dados. Verifique as credenciais.", "error");
                } else {
                    statusEl.textContent = "Supabase Conectado";
                    statusEl.className = "connection-status status-ok";
                }
            } catch (e) {
                console.error("Erro Fatal:", e);
            }

            await carregarDados();
            document.getElementById('loading-overlay').style.display = 'none';
        });

        function cacheDOM() {
            // Mapeia IDs para objeto els
            const ids = [
                'menu-toggle', 'sidebar', 'main-content', 'culto-form', 'data-culto', 'dia-semana', 
                'tipo-culto', 'hora-inicio', 'hora-termino', 'tempo-ministerio', 'homens', 'mulheres', 
                'criancas', 'total-presentes', 'ministro', 'dirigente', 'diaconato', 'infantil', 
                'musica', 'midia', 'observacoes', 'dashboard-cards', 'ultimos-cultos', 
                'historico-cultos', 'lista-escalas', 'lista-membros', 'btn-novo-membro', 
                'modal-membro', 'form-membro', 'modal-detalhes', 'modal-detalhes-content'
            ];
            ids.forEach(id => els[id] = document.getElementById(id));
            
            // Define data de hoje
            if(els['data-culto']) els['data-culto'].valueAsDate = new Date();
        }

        function bindEvents() {
            // Menu Mobile
            els['menu-toggle'].addEventListener('click', () => {
                els.sidebar.classList.toggle('active');
                els['main-content'].classList.toggle('active');
            });

            // Abas
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    link.classList.add('active');
                    const target = link.getAttribute('href').substring(1);
                    document.getElementById(target).classList.add('active');
                    
                    if(window.innerWidth < 992) {
                        els.sidebar.classList.remove('active');
                        els['main-content'].classList.remove('active');
                    }
                    
                    if (target === 'dashboard' || target === 'relatorios') renderCharts();
                });
            });

            // Calculadora Automática
            ['homens', 'mulheres', 'criancas'].forEach(id => {
                els[id].addEventListener('input', () => {
                    const total = (parseInt(els.homens.value)||0) + (parseInt(els.mulheres.value)||0) + (parseInt(els.criancas.value)||0);
                    els['total-presentes'].value = total;
                });
            });

            // Forms
            els['culto-form'].addEventListener('submit', salvarCulto);
            els['btn-novo-membro'].addEventListener('click', () => openModalMembro());
            els['form-membro'].addEventListener('submit', salvarMembro);
            
            // Modals Close
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
                });
            });
        }

        async function carregarDados() {
            try {
                const [resCultos, resEscalas, resMembros] = await Promise.all([
                    supabase.from('cultos').select('*').order('data_culto', { ascending: false }),
                    supabase.from('escalas').select('*'),
                    supabase.from('membros').select('*').order('nome')
                ]);

                estado.cultos = resCultos.data || [];
                estado.escalas = resEscalas.data || [];
                estado.membros = resMembros.data || [];

                atualizarUI();
            } catch (err) {
                console.error(err);
                mostrarToast('Erro ao carregar dados. Verifique a conexão.', 'error');
            }
        }

        function atualizarUI() {
            renderDashboard();
            renderHistorico();
            renderEscalas();
            renderMembros();
            renderCharts();
        }

        // --- RENDERIZADORES ---

        function renderDashboard() {
            const total = estado.cultos.length;
            const somaPublico = estado.cultos.reduce((acc, c) => acc + (c.homens+c.mulheres+c.criancas), 0);
            const media = total > 0 ? Math.round(somaPublico/total) : 0;
            
            els['dashboard-cards'].innerHTML = `
                <div class="card"><div class="card-value">${total}</div><div class="card-title">Cultos Realizados</div></div>
                <div class="card"><div class="card-value">${media}</div><div class="card-title">Média Público</div></div>
                <div class="card"><div class="card-value">${estado.membros.length}</div><div class="card-title">Membros Ativos</div></div>
            `;

            const ultimos = estado.cultos.slice(0, 5);
            els['ultimos-cultos'].innerHTML = ultimos.map(c => `
                <tr>
                    <td>${new Date(c.data_culto + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${c.dia_semana}</td>
                    <td>${c.tipo_culto}</td>
                    <td>${c.homens+c.mulheres+c.criancas}</td>
                    <td>${c.ministro}</td>
                    <td><button class="btn btn-secondary" onclick="verDetalhes(${c.id})"><i class="fas fa-eye"></i></button></td>
                </tr>
            `).join('');
        }

        function renderHistorico() {
            els['historico-cultos'].innerHTML = estado.cultos.map(c => `
                <tr>
                    <td>${new Date(c.data_culto + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${c.tipo_culto}</td>
                    <td><strong>${c.homens+c.mulheres+c.criancas}</strong></td>
                    <td>${c.hora_inicio}</td>
                    <td>${c.ministro}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deletarCulto(${c.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderEscalas() {
            const container = els['lista-escalas'];
            container.innerHTML = '';
            
            // Agrupar escalas por culto (últimos 10 cultos)
            const cultosRecentes = estado.cultos.slice(0, 10);
            
            cultosRecentes.forEach(culto => {
                const escalasCulto = estado.escalas.filter(e => e.culto_id === culto.id);
                if (escalasCulto.length === 0) return;
                
                const card = document.createElement('div');
                card.className = 'escalado-card';
                card.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px;">${new Date(culto.data_culto + 'T12:00:00').toLocaleDateString('pt-BR')} - ${culto.tipo_culto}</div>
                    ${escalasCulto.map(e => `<div style="font-size:0.9rem"><span style="color:var(--primary)">${e.departamento}:</span> ${e.nomes}</div>`).join('')}
                `;
                container.appendChild(card);
            });
        }

        function renderMembros() {
            els['lista-membros'].innerHTML = estado.membros.map(m => `
                <tr>
                    <td>${m.nome}</td>
                    <td>${m.email || '-'}</td>
                    <td>${(m.departamentos||[]).join(', ')}</td>
                    <td><span class="badge ${m.ativo ? 'badge-success' : 'badge-warning'}">${m.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td><button class="btn btn-danger" onclick="deletarMembro(${m.id})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function renderCharts() {
            if (estado.cultos.length === 0) return;

            // Chart 1: Tipos
            const tipos = {};
            estado.cultos.forEach(c => tipos[c.tipo_culto] = (tipos[c.tipo_culto]||0)+1);
            
            const ctx1 = document.getElementById('cultoTypeChart');
            if (estado.charts.type) estado.charts.type.destroy();
            estado.charts.type = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{ data: Object.values(tipos), backgroundColor: ['#1a5fb4', '#e67e22', '#28a745', '#ffc107', '#17a2b8'] }]
                }
            });

            // Chart 2: Demografia
            const totalH = estado.cultos.reduce((a,c)=>a+c.homens,0);
            const totalM = estado.cultos.reduce((a,c)=>a+c.mulheres,0);
            const totalC = estado.cultos.reduce((a,c)=>a+c.criancas,0);
            const count = estado.cultos.length;

            const ctx2 = document.getElementById('demographicsChart');
            if (estado.charts.demo) estado.charts.demo.destroy();
            estado.charts.demo = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Homens', 'Mulheres', 'Crianças'],
                    datasets: [{ 
                        label: 'Média', 
                        data: [totalH/count, totalM/count, totalC/count],
                        backgroundColor: ['#1a5fb4', '#e67e22', '#28a745']
                    }]
                }
            });
        }

        // --- AÇÕES CRUD ---

        async function salvarCulto(e) {
            e.preventDefault();
            const form = els['culto-form'];
            
            const novoCulto = {
                data_culto: els['data-culto'].value,
                dia_semana: els['dia-semana'].value,
                tipo_culto: els['tipo-culto'].value,
                hora_inicio: els['hora-inicio'].value,
                hora_termino: els['hora-termino'].value,
                tempo_ministerio: parseInt(els['tempo-ministerio'].value),
                homens: parseInt(els['homens'].value)||0,
                mulheres: parseInt(els['mulheres'].value)||0,
                criancas: parseInt(els['criancas'].value)||0,
                ministro: els['ministro'].value,
                dirigente: els['dirigente'].value,
                observacoes: els['observacoes'].value
            };

            const { data: culto, error } = await supabase.from('cultos').insert(novoCulto).select().single();
            
            if (error) return mostrarToast('Erro ao salvar culto: ' + error.message, 'error');

            // Salvar Escalas
            const escalas = [
                { depto: 'Diaconato', val: els['diaconato'].value },
                { depto: 'Infantil', val: els['infantil'].value },
                { depto: 'Música', val: els['musica'].value },
                { depto: 'Mídia', val: els['midia'].value }
            ];

            const escalasParaSalvar = escalas
                .filter(e => e.val.trim() !== '')
                .map(e => ({ culto_id: culto.id, departamento: e.depto, nomes: e.val }));

            if (escalasParaSalvar.length > 0) {
                await supabase.from('escalas').insert(escalasParaSalvar);
            }

            form.reset();
            mostrarToast('Culto salvo com sucesso!', 'success');
            await carregarDados();
            document.getElementById('dashboard-tab').click();
        }

        async function deletarCulto(id) {
            if(!confirm('Confirma exclusão?')) return;
            const { error } = await supabase.from('cultos').delete().eq('id', id);
            if(error) mostrarToast('Erro ao deletar', 'error');
            else {
                mostrarToast('Culto removido', 'success');
                carregarDados();
            }
        }

        async function salvarMembro(e) {
            e.preventDefault();
            const id = document.getElementById('membro-id').value;
            const nome = document.getElementById('membro-nome').value;
            const email = document.getElementById('membro-email').value;
            const deptos = document.getElementById('membro-departamentos').value.split(',').map(s => s.trim());

            const dados = { nome, email, departamentos: deptos };

            let error;
            if (id) {
                ({ error } = await supabase.from('membros').update(dados).eq('id', id));
            } else {
                ({ error } = await supabase.from('membros').insert(dados));
            }

            if (error) mostrarToast('Erro ao salvar membro', 'error');
            else {
                document.getElementById('modal-membro').classList.remove('active');
                carregarDados();
            }
        }

        async function deletarMembro(id) {
            if(!confirm('Excluir membro?')) return;
            const { error } = await supabase.from('membros').delete().eq('id', id);
            if (!error) carregarDados();
        }

        window.verDetalhes = async (id) => {
            const culto = estado.cultos.find(c => c.id === id);
            const escalas = estado.escalas.filter(e => e.culto_id === id);
            
            const content = document.getElementById('modal-detalhes-content');
            content.innerHTML = `
                <p><strong>Ministro:</strong> ${culto.ministro}</p>
                <p><strong>Observações:</strong> ${culto.observacoes || 'Nenhuma'}</p>
                <hr style="margin:10px 0">
                <h5>Escalas:</h5>
                ${escalas.length ? escalas.map(e => `<p>${e.departamento}: ${e.nomes}</p>`).join('') : '<p>Sem escalas</p>'}
            `;
            document.getElementById('modal-detalhes').classList.add('active');
        };

        function openModalMembro() {
            document.getElementById('form-membro').reset();
            document.getElementById('membro-id').value = '';
            document.getElementById('modal-membro').classList.add('active');
        }

        function mostrarToast(msg, tipo) {
            const t = document.createElement('div');
            t.className = `toast toast-${tipo}`;
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
